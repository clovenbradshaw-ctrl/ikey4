<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="card.title">iKey ID Card Generator</title>
    <link rel="icon" href="https://storage.googleapis.com/art_homelessness/favicon-32x32.png" type="image/png">
    <link rel="apple-touch-icon" href="https://storage.googleapis.com/art_homelessness/favicon-32x32.png">
    <script src="scripts/qrcode.min.js"></script>
    <script src="scripts/lz-string.min.js"></script>
    <script src="scripts/html2canvas.min.js"></script>
    <script src="scripts/translate.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 20px;
            color: #1e293b;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #fff;
            color: #000;
            padding: 8px 16px;
            z-index: 1000;
        }

        .skip-link:focus {
            top: 0;
        }

        *:focus-visible {
            outline: 3px solid #4f46e5;
            outline-offset: 2px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #374151;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .main-logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            color: #4f46e5;
        }

        .controls {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            color: #333;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .required-section {
            background: #f0f2ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #667eea;
        }

        .required-label {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .photo-section {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 25px;
        }

        .photo-preview {
            width: 100px;
            height: 120px;
            border: 3px dashed #ddd;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            text-align: center;
            color: #999;
            font-size: 0.85rem;
        }

        .photo-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .photo-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .photo-btn:hover {
            background: #667eea;
            color: white;
        }

        .remove-photo {
            background: #ff4757;
            color: white;
            border-color: #ff4757;
        }

        .remove-photo:hover {
            background: #ff3838;
        }

        #fileInput {
            display: none;
        }

        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .field-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .field-item.active {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .field-item.required {
            background: #f0f2ff;
            border-color: #667eea;
        }

        .field-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .field-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .field-label {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .field-label.required::after {
            content: " *";
            color: #667eea;
        }

        .char-counter {
            font-size: 0.75rem;
            color: #999;
        }

        .char-counter.warning {
            color: #ff9800;
        }

        .char-counter.error {
            color: #f44336;
        }

        .field-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .field-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .field-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        select.field-input {
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:focus-visible {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            flex: 1;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .preview-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .preview-title {
            text-align: center;
            font-weight: 600;
            color: #666;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .cards-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .card {
            width: 340px;
            height: 214px;
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .side-label {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 2px 6px;
            font-size: 0.55rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-weight: 600;
        }

        .card-front {
            padding: 15px;
            background: #f8f3e8;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-logo {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .card-title {
            font-weight: 800;
            font-size: 1rem;
            color: #333;
        }

        .id-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .card-email {
            font-size: 0.85rem;
            color: #333;
            font-weight: 600;
        }

        .card-id {
            font-size: 0.55rem;
            color: #666;
            font-weight: 500;
        }

        .guid-footer {
            margin-top: auto;
            width: 100%;
            text-align: center;
        }

        .id-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        .id-section.single {
            justify-content: center;
        }

        .card-photo {
            width: 100px;
            aspect-ratio: 5 / 6;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #ddd;
            background: white;
        }

        .photo-placeholder-card {
            width: 100px;
            aspect-ratio: 5 / 6;
            border-radius: 8px;
            border: 2px solid #ddd;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.7rem;
            flex-direction: column;
        }

        #qrcode {
            width: 120px !important;
            aspect-ratio: 1 / 1;
            padding: 7px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        #qrcode canvas,
        #qrcode img {
            width: 100% !important;
            height: auto !important;
        }

        .card-back {
            padding: 12px;
            background: white;
            height: 100%;
            display: grid;
            grid-template-rows: auto 1fr auto;
            row-gap: 8px;
        }

        .back-header {
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
            padding-bottom: 6px;
            border-bottom: 2px solid #e0e0e0;
        }

        .back-content {
            font-size: 0.72rem;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 12px;
            row-gap: 5px;
            padding-right: 4px;
        }

        .back-item {
            margin-bottom: 5px;
            display: flex;
            align-items: baseline;
            break-inside: avoid;
        }

        .back-label {
            font-weight: 600;
            color: #667eea;
            min-width: 65px;
        }

        .back-value {
            color: #333;
            word-break: break-word;
            flex: 1;
        }

        .back-value.critical {
            color: #d32f2f;
            font-weight: 600;
        }

        .emergency-box {
            padding: 8px;
            background: #ffebee;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #ffcdd2;
        }

        .emergency-label {
            color: #c62828;
            font-weight: 700;
            font-size: 0.7rem;
        }

        .emergency-value {
            color: #d32f2f;
            font-size: 0.95rem;
            font-weight: 700;
            margin-top: 2px;
        }

        .if-found-box {
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            text-align: center;
            border: 2px dashed #f59e0b;
            margin-top: 6px;
        }

        .if-found-label {
            color: #b45309;
            font-weight: 700;
            font-size: 0.7rem;
        }

        .if-found-value {
            color: #92400e;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 2px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container > *:not(.preview-container) {
                display: none;
            }

            .preview-container {
                box-shadow: none;
                padding: 0;
            }

            .preview-title {
                display: none;
            }

            .card {
                page-break-inside: avoid;
                height: auto;
                overflow: visible;
            }

            .back-content {
                overflow: visible;
            }

            @page {
                size: A4;
                margin: 15mm;
            }
        }

        @media (prefers-contrast: high) {
            .controls,
            .preview-container {
                border: 2px solid #000;
            }
        }

        /* Tooltip icon */
        .info-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 4px;
            background: url('https://storage.googleapis.com/art_homelessness/tool%20tip%20question%20mark.png') no-repeat center/contain;
            cursor: pointer;
            position: relative;
            font-size: 0;
        }

        .info-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 125%;
            background: #1e293b;
            color: white;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: normal;
            width: 200px;
            max-width: 250px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .info-icon:hover::after,
        .info-icon:focus::after {
            visibility: visible;
            opacity: 1;
        }

        /* Dark mode styles removed to maintain accessible contrast */
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <header class="header">
            <h1>
                <div class="main-logo">iK</div>
                <span data-i18n="card.header">iKey ID Card Generator</span>
            </h1>
            <p data-i18n="card.tagline">Minimalist secure iKey Emergency ID with unique identifier</p>
        </header>

        <main id="main-content">
        <div class="controls">
            <div class="section-title" data-i18n="card.photoUpload">Photo Upload (Optional)</div>
            <div class="photo-section">
                <div class="photo-preview" id="photoPreview">
                    <div class="photo-placeholder">
                        <div>üì∑</div>
                        <div data-i18n="card.noPhoto">No Photo</div>
                    </div>
                </div>
                <div class="photo-controls">
                    <button class="photo-btn" onclick="capturePhoto()" data-i18n="card.takePhoto">üì∏ Take Photo</button>
                    <button class="photo-btn" onclick="document.getElementById('fileInput').click()" data-i18n="card.uploadPhoto">üìÅ Upload Photo</button>
                    <button class="photo-btn remove-photo" onclick="removePhoto()" style="display:none;" id="removeBtn" data-i18n="card.removePhoto">‚ùå Remove</button>
                    <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
                </div>
            </div>

            <div class="section-title" data-i18n="card.requiredInfo">Required Information</div>
            <div class="required-section">
                <div class="required-label" data-i18n="card.requiredNote">
                    ‚ö° These fields are always included on your card
                </div>
                <div class="field-grid">
                    <div class="field-item required">
                        <div class="field-header">
                            <label class="field-label required" for="field_email" style="margin-left: 30px;" data-i18n="card.secureEmail">Secure Email (UID)</label>
                            <span class="char-counter" id="count_email">0/40</span>
                        </div>
                        <input type="email" class="field-input" id="field_email" maxlength="40"
                               placeholder="user@example.com" data-i18n-placeholder="placeholders.email" oninput="updateCharCount('email', 40)" required>
                    </div>

                    <div class="field-item required">
                        <div class="field-header">
                            <label class="field-label required" for="field_name" style="margin-left: 30px;" data-i18n="card.fullName">Full Name</label>
                            <span class="char-counter" id="count_name">0/30</span>
                        </div>
                        <input type="text" class="field-input" id="field_name" maxlength="30"
                               placeholder="John Doe" data-i18n-placeholder="placeholders.name" oninput="updateCharCount('name', 30)" required>
                    </div>

                    <div class="field-item required">
                        <div class="field-header">
                            <label class="field-label required" for="field_phone" style="margin-left: 30px;" data-i18n="card.phoneNumber">Your Phone Number</label>
                            <span class="char-counter" id="count_phone">0/20</span>
                        </div>
                        <input type="tel" class="field-input" id="field_phone" maxlength="20"
                               placeholder="+1-555-0123" data-i18n-placeholder="placeholders.phone" oninput="updateCharCount('phone', 20)" required>
                    </div>

                    <div class="field-item required">
                        <div class="field-header">
                            <label class="field-label required" for="field_emergency" style="margin-left: 30px;" data-i18n="card.emergencyContact">Emergency Contact</label>
                            <span class="char-counter" id="count_emergency">0/20</span>
                        </div>
                        <input type="tel" class="field-input" id="field_emergency" maxlength="20"
                               placeholder="+1-555-0123" data-i18n-placeholder="placeholders.emergencyPhone" oninput="updateCharCount('emergency', 20)" required>
                    </div>
                </div>
            </div>

            <div class="section-title" data-i18n="card.optionalInfo">Optional Medical Information (Back of Card)</div>
            <div class="field-grid">
                <div class="field-item active">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_dob" checked onchange="toggleField('dob')">
                        <label class="field-label" for="check_dob" data-i18n="card.dob">Date of Birth</label>
                    </div>
                    <input type="date" class="field-input" id="field_dob">
                </div>

                <div class="field-item active">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_blood" checked onchange="toggleField('blood')">
                        <label class="field-label" for="check_blood" data-i18n="card.bloodType">Blood Type</label>
                    </div>
                    <select class="field-input" id="field_blood">
                        <option value="O+" data-i18n="card.blood.oPos">O+</option>
                        <option value="O-" data-i18n="card.blood.oNeg">O-</option>
                        <option value="A+" data-i18n="card.blood.aPos">A+</option>
                        <option value="A-" data-i18n="card.blood.aNeg">A-</option>
                        <option value="B+" data-i18n="card.blood.bPos">B+</option>
                        <option value="B-" data-i18n="card.blood.bNeg">B-</option>
                        <option value="AB+" data-i18n="card.blood.abPos">AB+</option>
                        <option value="AB-" data-i18n="card.blood.abNeg">AB-</option>
                        <option value="Unknown" data-i18n="card.blood.unknown">Unknown</option>
                    </select>
                </div>

                <div class="field-item active">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_allergies" checked onchange="toggleField('allergies')">
                        <label class="field-label" for="check_allergies" data-i18n="card.allergies">Allergies</label>
                        <span class="char-counter" id="count_allergies">0/40</span>
                    </div>
                    <input type="text" class="field-input" id="field_allergies" maxlength="40"
                           placeholder="Penicillin, Peanuts" data-i18n-placeholder="placeholders.allergies" oninput="updateCharCount('allergies', 40)">
                </div>

                <div class="field-item">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_conditions" onchange="toggleField('conditions')">
                        <label class="field-label" for="check_conditions" data-i18n="card.medicalConditions">Medical Conditions</label>
                        <span class="char-counter" id="count_conditions">0/50</span>
                    </div>
                    <input type="text" class="field-input" id="field_conditions" maxlength="50"
                           placeholder="Diabetes Type 2, Hypertension" data-i18n-placeholder="placeholders.conditions" disabled
                           oninput="updateCharCount('conditions', 50)">
                </div>

                <div class="field-item">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_medications" onchange="toggleField('medications')">
                        <label class="field-label" for="check_medications" data-i18n="card.currentMedications">Current Medications</label>
                        <span class="char-counter" id="count_medications">0/50</span>
                    </div>
                    <input type="text" class="field-input" id="field_medications" maxlength="50"
                           placeholder="Metformin 500mg daily" data-i18n-placeholder="placeholders.medications" disabled
                           oninput="updateCharCount('medications', 50)">
                </div>

                <div class="field-item">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_insurance" onchange="toggleField('insurance')">
                        <label class="field-label" for="check_insurance" data-i18n="card.insurance">Insurance</label>
                        <span class="char-counter" id="count_insurance">0/35</span>
                    </div>
                    <input type="text" class="field-input" id="field_insurance" maxlength="35"
                           placeholder="Blue Cross Blue Shield" data-i18n-placeholder="placeholders.insurance" disabled
                           oninput="updateCharCount('insurance', 35)">
                </div>

                <div class="field-item">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_physician" onchange="toggleField('physician')">
                        <label class="field-label" for="check_physician" data-i18n="card.primaryPhysician">Primary Physician</label>
                        <span class="char-counter" id="count_physician">0/25</span>
                    </div>
                    <input type="text" class="field-input" id="field_physician" maxlength="25"
                           placeholder="Dr. Sarah Smith" data-i18n-placeholder="placeholders.physician" disabled
                           oninput="updateCharCount('physician', 25)">
                </div>

                <div class="field-item">
                    <div class="field-header">
                        <input type="checkbox" class="field-checkbox" id="check_donor" onchange="toggleField('donor')">
                        <label class="field-label" for="check_donor" data-i18n="card.organDonor">Organ Donor</label>
                    </div>
                    <select class="field-input" id="field_donor" disabled>
                        <option value="" data-i18n="card.notSpecified">Not Specified</option>
                        <option value="Yes" data-i18n="card.yes">Yes</option>
                        <option value="No" data-i18n="card.no">No</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateCard()" data-i18n="card.generateCard">üé® Generate Card</button>
                <button class="btn btn-success" onclick="window.print()" data-i18n="card.printCard">üñ®Ô∏è Print Card</button>
                <button class="btn btn-info" onclick="downloadCardImages()" data-i18n="card.downloadCards">üì• Download Cards</button>
                <button class="btn btn-info" onclick="downloadInfo()" data-i18n="card.downloadInfo">üíæ Download Info</button>
            </div>
        </div>

        <div class="preview-container">
            <div class="preview-title" data-i18n="card.cardPreview">Card Preview</div>
            <div class="cards-display">
                <div>
                    <div style="text-align: center; margin-bottom: 10px; color: #666; font-weight: 600;" data-i18n="card.front">Public Front</div>
                    <div class="card">
                        <div class="side-label" data-i18n="card.front">Public Front</div>
                        <div class="card-front">
                            <div class="card-header">
                                <div class="logo-area">
                                    <div class="card-logo">iK</div>
                                    <div class="card-title" data-i18n="card.cardName">iKey</div>
                                </div>
                                <div class="id-container">
                                    <div class="card-email" id="display_email">you@proton.me</div>
                                </div>
                            </div>

                            <div class="id-section" id="idSection">
                                <div id="cardPhotoContainer">
                                    <div class="photo-placeholder-card">
                                        <div>üì∑</div>
                                        <div data-i18n="card.noPhoto">No Photo</div>
                                    </div>
                                </div>
                                <div id="qrcode"></div>
                            </div>

                            <div class="guid-footer">
                                <div class="card-id" id="display_cardId">00000000-0000-0000-0000-000000000000</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div style="text-align: center; margin-bottom: 10px; color: #666; font-weight: 600;" data-i18n="card.back">Private Back</div>
                    <div class="card">
                        <div class="side-label" data-i18n="card.back">Private Back</div>
                        <div class="card-back">
                            <div class="back-header" data-i18n="card.medicalInfo">Medical Information</div>

                            <div class="back-content">
                                <div class="back-item">
                                    <span class="back-label" data-i18n="card.nameLabel">Name:</span>
                                    <span class="back-value" id="display_name"></span>
                                </div>

                                <div class="back-item">
                                    <span class="back-label" data-i18n="card.phoneLabel">Phone:</span>
                                    <span class="back-value" id="display_phone"></span>
                                </div>

                                <div class="back-item" id="back_dob">
                                    <span class="back-label" data-i18n="card.dobLabel">DOB:</span>
                                    <span class="back-value" id="display_dob"></span>
                                </div>

                                <div class="back-item" id="back_blood">
                                    <span class="back-label" data-i18n="card.bloodLabel">Blood:</span>
                                    <span class="back-value critical" id="display_blood"></span>
                                </div>

                                <div class="back-item" id="back_allergies">
                                    <span class="back-label" data-i18n="card.allergiesLabel">Allergies:</span>
                                    <span class="back-value critical" id="display_allergies"></span>
                                </div>

                                <div class="back-item" id="back_conditions" style="display:none;">
                                    <span class="back-label" data-i18n="card.conditionsLabel">Conditions:</span>
                                    <span class="back-value" id="display_conditions"></span>
                                </div>

                                <div class="back-item" id="back_medications" style="display:none;">
                                    <span class="back-label" data-i18n="card.medicationsLabel">Medications:</span>
                                    <span class="back-value" id="display_medications"></span>
                                </div>

                                <div class="back-item" id="back_physician" style="display:none;">
                                    <span class="back-label" data-i18n="card.physicianLabel">Physician:</span>
                                    <span class="back-value" id="display_physician"></span>
                                </div>

                                <div class="back-item" id="back_insurance" style="display:none;">
                                    <span class="back-label" data-i18n="card.insuranceLabel">Insurance:</span>
                                    <span class="back-value" id="display_insurance"></span>
                                </div>

                                <div class="back-item" id="back_donor" style="display:none;">
                                    <span class="back-label" data-i18n="card.donorLabel">Donor:</span>
                                    <span class="back-value" id="display_donor"></span>
                                </div>
                            </div>

                            <div class="emergency-box">
                                <div class="emergency-label" data-i18n="card.emergencyContactLabel">EMERGENCY CONTACT</div>
                                <div class="emergency-value" id="display_emergency"></div>
                            </div>
                            <div class="if-found-box" id="if-found-box" style="display:none;">
                                <div class="if-found-label">IF FOUND</div>
                                <div class="if-found-value" id="display_if_found"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </main>
    </div>

    <script>
        let qrCode = null;
        let photoData = null;
        let cardData = {};
        let ifFoundData = null;

        window.onload = function() {
            const hash = window.location.hash.slice(1);
            if (hash) {
                try {
                    const decompressed = LZString.decompressFromEncodedURIComponent(hash);
                    const data = JSON.parse(decompressed);
                    cardData = data;
                    ifFoundData = data.ifFound || null;
                    document.getElementById('field_email').value = data.pe || '';
                    document.getElementById('field_name').value = data.n || '';
                    document.getElementById('field_phone').value = data.ph || '';
                    document.getElementById('field_emergency').value = data.ep || '';

                    if (data.d) {
                        document.getElementById('check_dob').checked = true;
                        document.getElementById('field_dob').disabled = false;
                        document.getElementById('field_dob').value = data.d;
                        document.getElementById('field_dob').closest('.field-item').classList.add('active');
                    }
                    if (data.b) {
                        document.getElementById('check_blood').checked = true;
                        document.getElementById('field_blood').disabled = false;
                        document.getElementById('field_blood').value = data.b;
                        document.getElementById('field_blood').closest('.field-item').classList.add('active');
                    }
                    if (data.a) {
                        document.getElementById('check_allergies').checked = true;
                        document.getElementById('field_allergies').disabled = false;
                        document.getElementById('field_allergies').value = data.a;
                        document.getElementById('field_allergies').closest('.field-item').classList.add('active');
                    }
                    if (data.c) {
                        document.getElementById('check_conditions').checked = true;
                        document.getElementById('field_conditions').disabled = false;
                        document.getElementById('field_conditions').value = data.c;
                        document.getElementById('field_conditions').closest('.field-item').classList.add('active');
                    }
                    if (data.m) {
                        document.getElementById('check_medications').checked = true;
                        document.getElementById('field_medications').disabled = false;
                        document.getElementById('field_medications').value = data.m;
                        document.getElementById('field_medications').closest('.field-item').classList.add('active');
                    }
                    if (data.i) {
                        document.getElementById('check_insurance').checked = true;
                        document.getElementById('field_insurance').disabled = false;
                        document.getElementById('field_insurance').value = data.i;
                        document.getElementById('field_insurance').closest('.field-item').classList.add('active');
                    }
                    if (data.p) {
                        document.getElementById('check_physician').checked = true;
                        document.getElementById('field_physician').disabled = false;
                        document.getElementById('field_physician').value = data.p;
                        document.getElementById('field_physician').closest('.field-item').classList.add('active');
                    }
                    if (data.o) {
                        document.getElementById('check_donor').checked = true;
                        document.getElementById('field_donor').disabled = false;
                        document.getElementById('field_donor').value = data.o;
                        document.getElementById('field_donor').closest('.field-item').classList.add('active');
                    }
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }

            const fields = ['email', 'name', 'emergency', 'allergies', 'conditions', 
                          'medications', 'insurance', 'physician'];
            const limits = [40, 30, 20, 40, 50, 50, 35, 25];

            fields.forEach((field, i) => {
                updateCharCount(field, limits[i]);
            });

            // Automatically regenerate QR code whenever form data changes
            document.querySelectorAll('.field-input').forEach(input => {
                input.addEventListener('input', generateCard);
                input.addEventListener('change', generateCard);
            });

            generateCardId();
            generateCard();
        };

        function generateCardId() {
            const cardId = (typeof crypto.randomUUID === 'function')
                ? crypto.randomUUID()
                : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3) | 0x8;
                    return v.toString(16);
                });
            document.getElementById('display_cardId').textContent = cardId;
        }

        function toggleField(fieldName) {
            const checkbox = document.getElementById(`check_${fieldName}`);
            const input = document.getElementById(`field_${fieldName}`);
            const fieldItem = checkbox.closest('.field-item');

            if (checkbox.checked) {
                input.disabled = false;
                fieldItem.classList.add('active');
            } else {
                input.disabled = true;
                fieldItem.classList.remove('active');
            }

            generateCard();
        }

        function updateCharCount(fieldName, limit) {
            const input = document.getElementById(`field_${fieldName}`);
            const counter = document.getElementById(`count_${fieldName}`);

            if (input && counter) {
                const length = input.value.length;
                counter.textContent = `${length}/${limit}`;

                counter.classList.remove('warning', 'error');
                if (length > limit * 0.8) {
                    counter.classList.add('warning');
                }
                if (length >= limit) {
                    counter.classList.add('error');
                }
            }

        }

        function capturePhoto() {
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();

                    const captureUI = document.createElement('div');
                    captureUI.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.9);
                        z-index: 9999;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    `;

                    video.style.cssText = `
                        width: 250px;
                        height: 300px;
                        border-radius: 12px;
                        object-fit: cover;
                    `;

                    const captureBtn = document.createElement('button');
                    captureBtn.textContent = 'üì∏ Capture';
                    captureBtn.style.cssText = `
                        margin-top: 20px;
                        padding: 12px 30px;
                        background: #4CAF50;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 1.1rem;
                        cursor: pointer;
                        font-weight: 600;
                    `;

                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.style.cssText = `
                        margin-top: 10px;
                        padding: 10px 25px;
                        background: #666;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                    `;

                    captureUI.appendChild(video);
                    captureUI.appendChild(captureBtn);
                    captureUI.appendChild(cancelBtn);
                    document.body.appendChild(captureUI);

                    captureBtn.onclick = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0);

                        photoData = canvas.toDataURL('image/jpeg');
                        displayPhoto(photoData);

                        stream.getTracks().forEach(track => track.stop());
                        document.body.removeChild(captureUI);
                    };

                    cancelBtn.onclick = () => {
                        stream.getTracks().forEach(track => track.stop());
                        document.body.removeChild(captureUI);
                    };
                })
                .catch(err => {
                    alert('Camera access denied or not available');
                    console.error(err);
                });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                    displayPhoto(photoData);
                };
                reader.readAsDataURL(file);
            }
        }

        function displayPhoto(data) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<img src="${data}" alt="Photo preview">`;
            document.getElementById('removeBtn').style.display = 'block';

            updateCardDisplay();
        }

        function removePhoto() {
            photoData = null;
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `
                <div class="photo-placeholder">
                    <div>üì∑</div>
                    <div>No Photo</div>
                </div>
            `;
            document.getElementById('removeBtn').style.display = 'none';
            document.getElementById('fileInput').value = '';

            updateCardDisplay();
        }

        function updateCardDisplay() {
            const idSection = document.getElementById('idSection');
            const cardPhotoContainer = document.getElementById('cardPhotoContainer');

            if (photoData) {
                idSection.classList.remove('single');
                cardPhotoContainer.style.display = 'block';
                cardPhotoContainer.innerHTML = `<img class="card-photo" src="${photoData}" alt="User photo">`;
            } else {
                idSection.classList.add('single');
                cardPhotoContainer.style.display = 'none';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
        }

        function generateCard() {
            const requiredFields = {
                email: document.getElementById('field_email').value,
                name: document.getElementById('field_name').value,
                phone: document.getElementById('field_phone').value,
                emergency: document.getElementById('field_emergency').value
            };

            const optionalFields = ['dob', 'blood', 'allergies', 'conditions', 
                                   'medications', 'insurance', 'physician', 'donor'];

            const activeFields = {...requiredFields};
            optionalFields.forEach(field => {
                const checkbox = document.getElementById(`check_${field}`);
                if (checkbox && checkbox.checked) {
                    const input = document.getElementById(`field_${field}`);
                    activeFields[field] = input.value;
                }
            });

            document.getElementById('display_email').textContent = activeFields.email;
            document.getElementById('display_name').textContent = activeFields.name;
            document.getElementById('display_phone').textContent = activeFields.phone;
            document.getElementById('display_emergency').textContent = activeFields.emergency;

            optionalFields.forEach(field => {
                const backItem = document.getElementById(`back_${field}`);
                const display = document.getElementById(`display_${field}`);

                if (activeFields[field] !== undefined && activeFields[field]) {
                    if (backItem) backItem.style.display = 'flex';
                    if (display) {
                        if (field === 'dob') {
                            display.textContent = formatDate(activeFields[field]);
                        } else {
                            display.textContent = activeFields[field];
                        }
                    }
                } else {
                    if (backItem) backItem.style.display = 'none';
                }
            });
            const ifBox = document.getElementById('if-found-box');
            if (ifFoundData && ifFoundData.action !== 'none') {
                let msg = '';
                switch (ifFoundData.action) {
                    case 'destroy':
                        msg = 'Please destroy this card for privacy';
                        break;
                    case 'mail':
                        msg = `Please mail to:<br>${ifFoundData.mailAddress}`;
                        break;
                    case 'contact':
                        if (ifFoundData.contactType === 'emergency') {
                            msg = `Please contact emergency contact:<br>${cardData.ec || ''} - ${activeFields.emergency}`;
                        } else if (ifFoundData.contactType === 'case-manager') {
                            msg = `Please contact case manager:<br>${cardData.cm || ''} - ${cardData.cp || ''}`;
                        } else {
                            msg = `Please contact:<br>${ifFoundData.contactInfo}`;
                        }
                        break;
                    case 'other':
                        msg = ifFoundData.instructions || '';
                        break;
                }
                document.getElementById('display_if_found').innerHTML = msg;
                ifBox.style.display = 'block';
            } else {
                ifBox.style.display = 'none';
            }

            updateCardDisplay();
            generateQRCode(activeFields);
        }

        
        function generateQRCode(data) {
            const qrData = {
                v: 3,
                pe: data.email,
                n: data.name,
                ph: data.phone,
                ep: data.emergency,
                d: data.dob,
                b: data.blood,
                a: data.allergies,
                c: data.conditions,
                m: data.medications,
                i: data.insurance,
                p: data.physician,
                o: data.donor,
                ec: cardData.ec,
                er: cardData.er,
                cm: cardData.cm,
                co: cardData.co,
                cp: cardData.cp,
                ifFound: ifFoundData
            };

            const cleanData = {};
            Object.keys(qrData).forEach(key => {
                if (qrData[key]) cleanData[key] = qrData[key];
            });

            const jsonStr = JSON.stringify(cleanData);
            const compressed = LZString.compressToEncodedURIComponent(jsonStr);
            const basePath = window.location.pathname.replace('card.html', '');
            const baseURL = window.location.origin + basePath;
            const url = `${baseURL}#${compressed}`;
            const encodedUrl = encodeURI(url);

            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';

            qrCode = new QRCode(qrContainer, {
                text: encodedUrl,
                width: 240,
                height: 240,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
        }

        async function downloadCardImages() {
            const frontCard = document.querySelector('.card-front').parentElement;
            const backCard = document.querySelector('.card-back').parentElement;
            const backContent = backCard.querySelector('.back-content');

            // Preserve original styles
            const originalBackCardHeight = backCard.style.height;
            const originalBackCardOverflow = backCard.style.overflow;
            const originalContentHeight = backContent.style.height;
            const originalContentOverflow = backContent.style.overflow;

            // Expand back card to show all content
            backCard.style.height = 'auto';
            backCard.style.overflow = 'visible';
            backContent.style.height = 'auto';
            backContent.style.overflow = 'visible';

            const [frontCanvas, backCanvas] = await Promise.all([
                html2canvas(frontCard),
                html2canvas(backCard)
            ]);

            // Restore original styles
            backCard.style.height = originalBackCardHeight;
            backCard.style.overflow = originalBackCardOverflow;
            backContent.style.height = originalContentHeight;
            backContent.style.overflow = originalContentOverflow;

            const frontLink = document.createElement('a');
            frontLink.href = frontCanvas.toDataURL('image/png');
            frontLink.download = 'ikey-card-front.png';
            frontLink.click();

            const backLink = document.createElement('a');
            backLink.href = backCanvas.toDataURL('image/png');
            backLink.download = 'ikey-card-back.png';
            backLink.click();
        }

        function downloadInfo() {
            const data = {
                email: document.getElementById('field_email').value,
                name: document.getElementById('field_name').value,
                emergency: document.getElementById('field_emergency').value
            };

            const optionalFields = ['dob', 'blood', 'allergies', 'conditions', 
                                   'medications', 'insurance', 'physician', 'donor'];

            optionalFields.forEach(field => {
                const checkbox = document.getElementById(`check_${field}`);
                if (checkbox && checkbox.checked) {
                    const input = document.getElementById(`field_${field}`);
                    data[field] = input.value;
                }
            });

            const cardId = document.getElementById('display_cardId').textContent;

            const content = `iKey Emergency ID Card Information
Generated: ${new Date().toLocaleString()}
================================

Card ID: ${cardId}
Email (UID): ${data.email}
Name: ${data.name}
Emergency Contact: ${data.emergency}
${data.dob ? `Date of Birth: ${formatDate(data.dob)}\n` : ''}${data.blood ? `Blood Type: ${data.blood}\n` : ''}${data.allergies ? `Allergies: ${data.allergies}\n` : ''}${data.conditions ? `Medical Conditions: ${data.conditions}\n` : ''}${data.medications ? `Current Medications: ${data.medications}\n` : ''}${data.physician ? `Primary Physician: ${data.physician}\n` : ''}${data.insurance ? `Insurance: ${data.insurance}\n` : ''}${data.donor ? `Organ Donor: ${data.donor}\n` : ''}

================================
‚ö†Ô∏è Keep this information secure
üìß Your email serves as your unique identifier
`;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `iKey_${cardId}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.error('SW registration failed', err));
        }
    </script>
</body>
</html>
