<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'none';">
    <title>iKey Health - Secure Medical System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --text-scale: 1;
            --spacing-scale: 1;
            --element-scale: 1;
        }

        body.size-small { --text-scale: 0.875; --spacing-scale: 0.9; --element-scale: 0.95; }
        body.size-normal { --text-scale: 1; --spacing-scale: 1; --element-scale: 1; }
        body.size-large { --text-scale: 1.125; --spacing-scale: 1.1; --element-scale: 1.05; }
        body.size-xlarge { --text-scale: 1.25; --spacing-scale: 1.2; --element-scale: 1.1; }

        html {
            font-size: calc(16px * var(--text-scale));
        }

        body {
            min-height: 100vh;
            color: var(--text);
            position: relative;
        }

        body.theme-default {
            --primary: #4F46E5;
            --primary-dark: #3730A3;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --surface: #FFFFFF;
            --surface-alt: #F9FAFB;
            --text: #111827;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --glass: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --gac: #8B5CF6;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body.theme-topsecret {
            --primary: #ff6b00;
            --primary-dark: #cc5500;
            --danger: #ff0000;
            --success: #00ff00;
            --warning: #ffff00;
            --surface: #1a1a1a;
            --surface-alt: #0d0d0d;
            --text: #ff6b00;
            --text-secondary: #cc5500;
            --border: #ff6b00;
            --glass: rgba(0, 0, 0, 0.95);
            background: #000;
            font-family: 'Courier New', monospace;
        }

        body.theme-topsecret::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(255, 107, 0, 0.03) 2px,
                rgba(255, 107, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }

        body.theme-topsecret .nav-tab.locked::after {
            content: '[CLASSIFIED]';
            font-size: 0.6rem;
            color: #ff0000;
        }

        body.theme-topsecret h1,
        body.theme-topsecret h2 {
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 2px dashed #ff6b00;
        }

        body.theme-topsecret .status-message {
            border: 3px double #ff6b00;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 107, 0, 0.1) 10px,
                rgba(255, 107, 0, 0.1) 20px
            );
            text-transform: uppercase;
        }

        body.theme-hacker {
            --primary: #00ff00;
            --primary-dark: #00cc00;
            --danger: #ff0000;
            --success: #00ff00;
            --surface: #000000;
            --surface-alt: #0a0a0a;
            --text: #00ff00;
            --text-secondary: #00cc00;
            --border: #00ff00;
            background: #000;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        body.theme-hacker::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><text x="0" y="20" fill="%2300ff00" font-family="Consolas" font-size="20">010101</text></svg>');
            opacity: 0.1;
            pointer-events: none;
            animation: matrix-fall 20s linear infinite;
        }

        @keyframes matrix-fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        body.theme-hacker input:focus::after {
            content: '_';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        body.theme-hacker .form-group label::before {
            content: '> ';
            color: #00ff00;
        }

        body.theme-hacker .btn {
            text-shadow: 0 0 10px #00ff00;
            border: 1px solid #00ff00;
            background: transparent;
        }

        body.theme-wellness {
            --primary: #7c9885;
            --primary-dark: #5a7261;
            --success: #a8c09a;
            --surface: #faf8f3;
            --surface-alt: #f0ede5;
            --text: #3d4a3d;
            --text-secondary: #6b7c6b;
            --border: #d4cfc0;
            background: linear-gradient(135deg, #faf8f3 0%, #e8e2d5 100%);
            font-family: 'Segoe UI', 'San Francisco', sans-serif;
        }

        body.theme-wellness * {
            border-radius: calc(var(--base-radius, 8px) * 1.5);
        }

        body.theme-wellness .btn {
            animation: breathe 4s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        body.theme-wellness .content-section {
            background-image:
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 50px,
                    rgba(124, 152, 133, 0.02) 50px,
                    rgba(124, 152, 133, 0.02) 51px
                );
        }

        body.theme-contrast {
            --primary: #000000;
            --danger: #000000;
            --success: #000000;
            --surface: #ffffff;
            --surface-alt: #ffffff;
            --text: #000000;
            --text-secondary: #000000;
            --border: #000000;
        }

        body.theme-contrast.dark-mode {
            --primary: #ffffff;
            --surface: #000000;
            --surface-alt: #000000;
            --text: #ffffff;
            --border: #ffffff;
        }

        body.theme-contrast * {
            border-width: 3px !important;
            font-weight: bold !important;
        }

        body.theme-contrast *:focus {
            outline: 4px solid var(--primary);
            outline-offset: 2px;
        }

        body.theme-contrast::before,
        body.theme-contrast::after {
            display: none !important;
        }

        body.theme-retro {
            --primary: #4a7c59;
            --surface: #f4f1e8;
            --surface-alt: #e8ddc7;
            --text: #2d2d2d;
            --border: #9b8f7e;
            background: #f4f1e8;
            font-family: 'American Typewriter', 'Courier', serif;
        }

        body.theme-retro .nav-tab {
            background: linear-gradient(to bottom, #e8ddc7 0%, #d4c4a8 100%);
            border: 1px solid #9b8f7e;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
        }

        body.theme-retro .content-section {
            background-image:
                linear-gradient(rgba(75, 124, 89, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(75, 124, 89, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        body.theme-retro .status-success {
            transform: rotate(-5deg);
            border: 3px double #4a7c59;
            border-radius: 50%;
            text-transform: uppercase;
        }

        .container {
            width: 100%;
            padding: calc(12px * var(--spacing-scale));
            min-height: 100vh;
        }

        /* Setup Wizard Styles */
        .setup-wizard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .setup-wizard.hidden {
            display: none;
        }

        .wizard-container {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .wizard-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .wizard-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .wizard-progress {
            display: flex;
            padding: 20px 30px;
            background: var(--surface-alt);
            border-bottom: 1px solid var(--border);
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .progress-step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border);
            z-index: -1;
        }

        .progress-step:last-child::after {
            display: none;
        }

        .progress-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--border);
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .progress-step.active .progress-dot {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .progress-step.completed .progress-dot {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .wizard-content {
            padding: 30px;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-actions {
            padding: 20px 30px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 20px;
            z-index: 100;
        }

        .processing-message {
            margin-top: 20px;
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 500;
        }

        .header {
            background: var(--surface);
            border-radius: calc(12px * var(--element-scale));
            padding: calc(12px * var(--spacing-scale));
            margin-bottom: calc(12px * var(--spacing-scale));
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-controls {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .security-badge {
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .badge-public {
            background: var(--surface-alt);
            color: var(--text-secondary);
        }

        .badge-pin {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
        }

        .badge-password {
            background: rgba(139, 92, 246, 0.1);
            color: var(--gac);
        }

        .nav-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px;
        }

        .nav-tab {
            background: var(--surface);
            border: none;
            padding: 14px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            white-space: nowrap;
            flex-shrink: 0;
            position: relative;
        }

        .nav-tab.locked::after {
            content: '🔒';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.7rem;
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .nav-tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content-section {
            background: var(--surface);
            border-radius: calc(12px * var(--element-scale));
            padding: calc(16px * var(--spacing-scale));
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: calc(20px * var(--spacing-scale));
        }

        .form-group label {
            display: block;
            margin-bottom: calc(6px * var(--spacing-scale));
            font-weight: 500;
            color: var(--text);
            font-size: calc(0.875rem * var(--text-scale));
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--danger);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: calc(12px * var(--spacing-scale)) calc(14px * var(--spacing-scale));
            border: 2px solid var(--border);
            border-radius: calc(8px * var(--element-scale));
            font-size: calc(1rem * var(--text-scale));
            transition: all 0.2s;
            background: var(--surface);
            min-height: calc(48px * var(--element-scale));
            touch-action: manipulation;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .size-controls {
            display: flex;
            gap: calc(8px * var(--spacing-scale));
        }

        .size-btn {
            padding: calc(8px * var(--spacing-scale));
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: calc(6px * var(--element-scale));
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: calc(14px * var(--spacing-scale)) calc(24px * var(--spacing-scale));
            background: var(--primary);
            color: white;
            border: none;
            border-radius: calc(10px * var(--element-scale));
            font-size: calc(1rem * var(--text-scale));
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: calc(8px * var(--spacing-scale));
            min-height: calc(48px * var(--element-scale));
            touch-action: manipulation;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--text-secondary);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--primary);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .info-card {
            background: var(--surface-alt);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .info-card-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .info-card-content {
            flex: 1;
        }

        .info-card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .info-card-value {
            font-size: 1rem;
            color: var(--text);
            font-weight: 500;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3500;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px 16px;
            width: 100%;
            max-width: 420px;
            margin: 0 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            text-align: center;
            color: var(--text);
            margin-bottom: 24px;
            font-size: 1.25rem;
            font-weight: 500;
        }

        .pin-display {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 32px auto;
            max-width: 320px;
        }

        .pin-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(79, 70, 229, 0.2);
            border: 2px solid rgba(79, 70, 229, 0.3);
            transition: all 0.3s;
        }

        .pin-dot.filled {
            background: var(--primary);
            transform: scale(1.3);
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.5);
        }

        .pin-dot.error {
            background: var(--danger);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            max-width: 360px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 8px;
        }

        .pin-key {
            background: rgba(79, 70, 229, 0.1);
            border: 2px solid rgba(79, 70, 229, 0.3);
            border-radius: 14px;
            padding: 0;
            font-size: 1.8rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            min-height: 65px;
            height: 65px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .pin-key:hover {
            background: rgba(79, 70, 229, 0.2);
            transform: scale(1.05);
        }

        .pin-key:active {
            transform: scale(0.95);
            background: rgba(79, 70, 229, 0.3);
        }

        .pin-key.special-clear {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            font-size: 1.2rem;
        }

        .pin-key.special-cancel {
            background: rgba(107, 114, 128, 0.1);
            border-color: rgba(107, 114, 128, 0.3);
            font-size: 1.2rem;
        }

        .password-modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .password-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .password-strength {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }

        .strength-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            transition: background 0.3s;
        }

        .strength-bar.active {
            background: var(--success);
        }

        .strength-bar.weak {
            background: var(--danger);
        }

        .strength-bar.medium {
            background: var(--warning);
        }

        /* EHR Specific Styles */
        .ehr-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--surface-alt);
            padding: 8px;
            border-radius: 8px;
        }

        .ehr-tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .ehr-tab.active {
            background: var(--gac);
            color: white;
            border-color: var(--gac);
        }

        .ehr-section {
            display: none;
        }

        .ehr-section.active {
            display: block;
        }

        .provider-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--surface-alt);
            position: relative;
        }

        .provider-status-green {
            border-left: 4px solid var(--success);
        }

        .provider-status-yellow {
            border-left: 4px solid var(--warning);
        }

        .provider-status-red {
            border-left: 4px solid var(--danger);
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .case-note {
            background: var(--surface-alt);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 3px solid var(--primary);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-box {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
        }

        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border-radius: 12px;
            padding: 10px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            min-width: 200px;
            max-width: 300px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .status-bar.active {
            opacity: 1;
            transform: translateY(0);
        }

        .status-content {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-bar.success {
            background: var(--success);
            color: white;
        }

        .status-bar.error {
            background: var(--danger);
            color: white;
        }

        .status-bar.info {
            background: var(--primary);
            color: white;
        }

        .status-bar.warning {
            background: var(--warning);
            color: white;
        }

        .sync-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pin-reset-link {
            text-align: center;
            margin-top: 12px;
            font-size: 0.875rem;
        }

        .pin-reset-link a {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }

        .pin-reset-link a:hover {
            text-decoration: underline;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin: 20px 0;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        #qrcode canvas {
            display: block !important;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .wizard-container {
                margin: 10px;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }

        .hidden {
            display: none !important;
        }

        .mt-4 {
            margin-top: 2rem;
        }

        .mb-4 {
            margin-bottom: 2rem;
        }

        .section-header {
            border-bottom: 2px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 20px;
        }

        .add-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 12px;
        }

        .add-button:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body class="theme-default size-normal">
    <!-- Setup Wizard -->
    <div id="setup-wizard" class="setup-wizard hidden">
        <div class="wizard-container">
            <div class="wizard-header">
                <h1>🔑 Welcome to iKey Health</h1>
                <p>Your secure, tiered medical information system</p>
            </div>
            
            <div class="wizard-progress">
                <div class="progress-step active" data-step="1">
                    <div class="progress-dot">1</div>
                    <div class="progress-label">Welcome</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="progress-dot">2</div>
                    <div class="progress-label">Emergency Info</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="progress-dot">3</div>
                    <div class="progress-label">Security Setup</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="progress-dot">4</div>
                    <div class="progress-label">Complete</div>
                </div>
            </div>
            
            <div class="wizard-content">
                <!-- Step 1: Welcome -->
                <div class="wizard-step active" data-step="1">
                    <h2>Three Levels of Security</h2>
                    <p style="margin-bottom: 20px;">iKey Health protects your medical information with three security tiers:</p>
                    
                    <div class="info-card">
                        <span class="info-card-icon">🚨</span>
                        <div class="info-card-content">
                            <div class="info-card-label">Level 1: Emergency (QR Code)</div>
                            <div class="info-card-value">Critical info for first responders - accessible via QR code</div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <span class="info-card-icon">📝</span>
                        <div class="info-card-content">
                            <div class="info-card-label">Level 2: Demographics (PIN)</div>
                            <div class="info-card-value">Contact info and basic details - protected by 6-digit PIN</div>
                        </div>
                    </div>

                    <div class="info-card">
                        <span class="info-card-icon">🔐</span>
                        <div class="info-card-content">
                            <div class="info-card-label">Level 3: Health Records (Password)</div>
                            <div class="info-card-value">Sensitive medical history and test results - secured by strong password</div>
                        </div>
                    </div>
                    
                    <div class="warning-box">
                        <strong>Important:</strong> Your PIN and password ARE your encryption keys. They cannot be recovered if lost. Store them safely.
                    </div>
                </div>
                
                <!-- Step 2: Emergency Info -->
                <div class="wizard-step" data-step="2">
                    <h2>Emergency Information</h2>
                    <p style="margin-bottom: 20px;">This information will be accessible to first responders via QR code:</p>
                    
                    <div class="form-group">
                        <label class="required">Your Name</label>
                        <input type="text" id="setup-name" placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label>Blood Type</label>
                        <select id="setup-blood">
                            <option value="">Unknown</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">Emergency Contact Name</label>
                        <input type="text" id="setup-contact-name" placeholder="Full name of emergency contact">
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label class="required">Contact Phone</label>
                            <input type="tel" id="setup-contact-phone" placeholder="Phone number">
                        </div>

                        <div class="form-group">
                            <label class="required">Relationship</label>
                            <select id="setup-contact-relationship" onchange="handleRelationshipChange('setup')">
                                <option value="">Select relationship</option>
                                <option value="spouse">Spouse/Partner</option>
                                <option value="parent">Parent</option>
                                <option value="child">Child</option>
                                <option value="sibling">Sibling</option>
                                <option value="case-manager">Case Manager</option>
                                <option value="employer">Employer</option>
                                <option value="friend">Friend</option>
                                <option value="prefer-not">Prefer not to answer</option>
                                <option value="other">Other (specify)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="setup-other-relationship-group" style="display: none;">
                        <label>Please specify relationship</label>
                        <input type="text" id="setup-contact-other" placeholder="Describe relationship">
                    </div>
                    
                    <div class="form-group">
                        <label>Allergies</label>
                        <textarea id="setup-allergies" placeholder="List any allergies (medications, foods, etc.)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Current Medications</label>
                        <textarea id="setup-medications" placeholder="List current medications"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Medical Conditions</label>
                        <textarea id="setup-conditions" placeholder="List medical conditions (diabetes, heart disease, etc.)"></textarea>
                    </div>
                </div>
                
                <!-- Step 3: Security Setup -->
                <div class="wizard-step" data-step="3">
                    <h2>Set Up Your Security Layers</h2>
                    <p style="margin-bottom: 20px;">Your data is protected by multiple security layers. Set each one:</p>

                    <div class="security-tier-card">
                        <div class="tier-header">
                            <span class="tier-icon">📝</span>
                            <h3>Level 1: PIN (Demographics)</h3>
                        </div>
                        <div class="tier-info">
                            <p><strong>Protects:</strong> Contact info, address, phone numbers, non-medical updates</p>
                            <p><strong>Why PIN is OK here:</strong> Lower risk data, convenience for frequent updates</p>
                        </div>
                        <div class="form-group">
                            <label>Enter 6-Digit PIN</label>
                            <button type="button" class="btn" onclick="requestPINForSetup()">Set PIN</button>
                            <div id="setup-pin-display" style="display:none;">PIN Set ✓</div>
                            <input type="hidden" id="setup-pin">
                            <small>Easy to remember, for non-sensitive updates</small>
                        </div>
                    </div>

                    <div class="security-tier-card">
                        <div class="tier-header">
                            <span class="tier-icon">🏥</span>
                            <h3>Level 2: Password (Health Records)</h3>
                        </div>
                        <div class="tier-info">
                            <p><strong>Protects:</strong> Medical history, conditions, medications, test results</p>
                            <p><strong>Why password:</strong> Sensitive medical data needs strong protection</p>
                        </div>
                        <div class="form-group">
                            <label>Enter Password (minimum 12 characters)</label>
                            <input type="password"
                                   id="setup-health-password"
                                   minlength="12"
                                   placeholder="Strong password">
                            <div class="password-strength">
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                            </div>
                            <small>This is your main medical records password</small>
                        </div>
                    </div>

                    <div class="warning-box">
                        <strong>⚠️ Important:</strong> These cannot be recovered if forgotten. Write them down and store safely.
                    </div>
                </div>

                <!-- Step 4: Complete -->
                <div class="wizard-step" data-step="4">
                    <h2>🎉 Setup Complete!</h2>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div id="setup-qrcode"></div>
                    </div>
                    
                    <p style="margin-bottom: 20px;">Your iKey Health system is ready! Here's what you can do:</p>
                    
                    <div class="info-card">
                        <span class="info-card-icon">📱</span>
                        <div class="info-card-content">
                            <div class="info-card-label">Save This QR Code</div>
                            <div class="info-card-value">Screenshot or download it - first responders can scan it for emergency info</div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <span class="info-card-icon">☁️</span>
                        <div class="info-card-content">
                            <div class="info-card-label">Automatic Backup</div>
                            <div class="info-card-value">Your encrypted data syncs to the cloud automatically</div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <span class="info-card-icon">💾</span>
                        <div class="info-card-content">
                            <div class="info-card-label">Save This Page</div>
                            <div class="info-card-value">Bookmark this page or save it offline for future access</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="downloadSetupQR()" style="width: 100%; margin-top: 20px;">
                        📥 Download QR Code
                    </button>
                </div>
            </div>
            
            <div class="wizard-actions">
                <button class="btn btn-secondary" id="wizard-back" onclick="wizardBack()">Back</button>
                <button class="btn" id="wizard-next" onclick="wizardNext()">Next</button>
                <button class="btn btn-success hidden" id="wizard-complete" onclick="completeSetup()">Start Using iKey</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <span>🔑</span>
                <span>iKey Health</span>
            </div>
            <div class="header-controls">
                <div class="security-badge badge-public" id="securityBadge">
                    <span id="lockIcon">🔓</span>
                    <span id="lockText">Public Access</span>
                </div>
                <button class="btn btn-outline" onclick="showPasswordManager()" id="passwordBtn" style="display: none; padding: 8px 16px; font-size: 0.875rem;">
                    🔑 Manage Password
                </button>
                <button class="btn btn-outline" onclick="switchInstance()" id="switchInstanceBtn" style="padding: 8px 16px; font-size: 0.875rem;">
                    🔄 Switch Profile
                </button>
                <button class="btn btn-outline" onclick="createNewInstance()" id="newInstanceBtn" style="padding: 8px 16px; font-size: 0.875rem;">
                    ➕ New Profile
                </button>
                <div class="security-badge" id="syncIndicator" style="display: none;">
                    <span>☁️</span>
                    <span id="syncText">Syncing...</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" onclick="showTab('emergency')" data-tab="emergency">
                🚨 Emergency
            </button>
            <button class="nav-tab locked" onclick="showTab('health')" data-tab="health" id="healthTab">
                🏥 Health Info
            </button>
            <button class="nav-tab locked" onclick="showTab('security')" data-tab="security" id="securityTab">
                🔒 Security
            </button>
            <button class="nav-tab locked hidden" onclick="showTab('ehr')" data-tab="ehr" id="ehrTab">
                📋 Full EHR
            </button>
        </div>

        <!-- Emergency Section (Public Tier) -->
        <div class="content-section active" id="emergency-section">
            <div class="section-header">
                <h2>Emergency Medical Information</h2>
            </div>
            <div id="emergency-display"></div>
            <div class="btn-group mt-4">
                <button class="btn" onclick="requestPIN('edit')">
                    🔐 Edit Information
                </button>
                <button class="btn btn-outline" onclick="generateMainQR()">
                    📱 Generate QR Code
                </button>
            </div>
            <div id="qr-display" class="qr-container hidden">
                <div id="main-qrcode"></div>
                <div class="mt-4">
                    <button class="btn btn-success" onclick="downloadMainQR()">
                        📥 Download QR
                    </button>
                </div>
            </div>
        </div>

        <!-- Health Section (PIN Tier) -->
        <div class="content-section" id="health-section">
            <div class="section-header">
                <h2>Health Information</h2>
            </div>
            
            <div class="form-group">
                <label>Current Medical Conditions</label>
                <textarea id="conditions" class="protected-data" data-field="conditions" placeholder="List current medical conditions..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Past Surgeries</label>
                <textarea id="surgeries" class="protected-data" data-field="surgeries" placeholder="List past surgeries..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Family Medical History</label>
                <textarea id="family-history" class="protected-data" data-field="familyHistory" placeholder="Relevant family medical history..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea id="health-notes" class="protected-data" data-field="notes" placeholder="Additional health notes..."></textarea>
            </div>
            
            <button class="btn btn-success" onclick="saveHealthInfo()">
                💾 Save Health Information
            </button>
            
            <div class="info-box mt-4">
                <strong>Want comprehensive medical records?</strong> Set a password to unlock the full Electronic Health Record system with detailed provider management, medications tracking, and more.
                <div class="mt-4">
                    <button class="btn" onclick="requestPassword('set')">
                        🔐 Set Password for Full EHR
                    </button>
                </div>
            </div>
        </div>

        <!-- Security Section (PIN Tier) -->
        <div class="content-section" id="security-section">
            <div class="section-header">
                <h2>Security & Access</h2>
            </div>
            
            <div class="mb-4">
                <h3>PIN Management</h3>
                <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.875rem;">
                    Set and manage your PIN for accessing protected health data.
                </p>
            </div>
            
            <div class="mb-4">
                <h3>Data Management</h3>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="syncToCloud()">
                        ☁️ Sync to Cloud
                    </button>
                    <button class="btn btn-outline" onclick="exportData()">
                        📥 Export All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- EHR Section (Password Tier) -->
        <div class="content-section" id="ehr-section">
            <div class="section-header">
                <h2>📋 Comprehensive Electronic Health Record</h2>
            </div>
            
            <div class="ehr-nav">
                <button class="ehr-tab active" onclick="showEHRSection('identity')">Identity</button>
                <button class="ehr-tab" onclick="showEHRSection('providers')">Providers</button>
                <button class="ehr-tab" onclick="showEHRSection('medications')">Medications</button>
                <button class="ehr-tab" onclick="showEHRSection('conditions')">Conditions</button>
                <button class="ehr-tab" onclick="showEHRSection('notes')">Case Notes</button>
            </div>
            
            <!-- Identity Section -->
            <div class="ehr-section active" id="ehr-identity">
                <h3>Identity & Safety Preferences</h3>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Chosen Name</label>
                        <input type="text" class="ehr-data" data-field="chosenName" />
                    </div>
                    <div class="form-group">
                        <label>Pronouns</label>
                        <input type="text" class="ehr-data" data-field="pronouns" />
                    </div>
                </div>
            </div>
            
            <!-- Providers Section -->
            <div class="ehr-section" id="ehr-providers">
                <h3>Healthcare Providers</h3>
                <div id="providers-container"></div>
                <button class="add-button" onclick="addProvider()">+ Add Provider</button>
            </div>
            
            <!-- Medications Section -->
            <div class="ehr-section" id="ehr-medications">
                <h3>Current Medications</h3>
                <div id="medications-container"></div>
                <button class="add-button" onclick="addMedication()">+ Add Medication</button>
            </div>
            
            <!-- Conditions Section -->
            <div class="ehr-section" id="ehr-conditions">
                <h3>Medical Conditions</h3>
                <div id="conditions-container"></div>
                <button class="add-button" onclick="addCondition()">+ Add Condition</button>
            </div>
            
            <!-- Case Notes Section -->
            <div class="ehr-section" id="ehr-notes">
                <h3>Case Notes</h3>
                <div id="case-notes-container"></div>
                <button class="add-button" onclick="addCaseNote()">+ Add Note</button>
            </div>
            
            <div class="btn-group mt-4">
                <button class="btn btn-success" onclick="saveEHR()">💾 Save EHR</button>
                <button class="btn btn-outline" onclick="exportEHR()">📄 Export Record</button>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pin-modal" class="modal-overlay">
        <div class="modal-container">
            <h3 class="modal-title" id="pin-modal-title">Enter 6-Digit PIN</h3>
            
            <div class="pin-display" id="pinDisplay">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            
            <div class="pin-keypad">
                <button class="pin-key" onclick="addPinDigit(1)">1</button>
                <button class="pin-key" onclick="addPinDigit(2)">2</button>
                <button class="pin-key" onclick="addPinDigit(3)">3</button>
                <button class="pin-key" onclick="addPinDigit(4)">4</button>
                <button class="pin-key" onclick="addPinDigit(5)">5</button>
                <button class="pin-key" onclick="addPinDigit(6)">6</button>
                <button class="pin-key" onclick="addPinDigit(7)">7</button>
                <button class="pin-key" onclick="addPinDigit(8)">8</button>
                <button class="pin-key" onclick="addPinDigit(9)">9</button>
                <button class="pin-key special-clear" onclick="clearPin()">Clear</button>
                <button class="pin-key" onclick="addPinDigit(0)">0</button>
                <button class="pin-key special-cancel" onclick="closePinPad()">Cancel</button>
            </div>
            
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="modal-overlay">
        <div class="password-modal">
            <h3 id="password-title">Set Password for Full EHR</h3>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password-input" class="password-input" placeholder="Enter password">
                <div class="password-strength" id="password-strength">
                    <div class="strength-bar"></div>
                    <div class="strength-bar"></div>
                    <div class="strength-bar"></div>
                    <div class="strength-bar"></div>
                </div>
            </div>
            
            <div class="form-group" id="confirm-group">
                <label>Confirm Password</label>
                <input type="password" id="confirm-password" class="password-input" placeholder="Confirm password">
            </div>
            
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 12px;">
                This password encrypts your full medical records. It cannot be recovered if lost.
            </p>
            
            <div class="btn-group mt-4">
                <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                <button class="btn btn-success" onclick="submitPassword()">Continue</button>
            </div>
        </div>
    </div>

    <!-- QR Code Library - Try multiple CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Fallback QR library loader
        if (typeof QRCode === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
            document.head.appendChild(script);
        }
    </script>

    <script>
        // Global State Management
        const APP_VERSION = '2.0.0';
        const APP_URL = new URL('.', window.location.href).href;
        const WEBHOOK_URL = 'https://n8n.intelechia.com/webhook/d5e99c29-2cf1-44c1-b5b4-95a1ca048441';
        const XANO_CACHE_URL = 'https://xvkq-pq7i-idtl.n7d.xano.io/api:Hj4C6PGO/ikey_cache';
        const ARCHIVE_BASE_URL = 'https://archive.org/download/zuboff';
        const AUTO_LOGOUT_MS = 45 * 60 * 1000;
        let pinEntry = '';

        const state = {
            currentGUID: null,
            baseKey: null,
            pinKey: null,
            passwordKey: null,
            pinUnlocked: false,
            passwordUnlocked: false,
            isFirstTime: false,
            autoSaveTimer: null,
            lastSync: null,
            lastActivity: Date.now(),
            logoutTimer: null,
            logoutWarningTimer: null,
            currentDoubleHash: null,
            saltValue: null,

            telemetry: {
                lastRestoreSource: null,
                lastSyncResults: {}
            },

            pinAttemptsRemaining: 5,

            publicData: {
                emergency: {}
            },

            protectedData: {
                health: {}
            },

            secureData: {
                ehr: null
            }
        };

        const ThemeManager = {
            themes: ['default', 'topsecret', 'hacker', 'wellness', 'contrast', 'retro'],
            sizes: ['small', 'normal', 'large', 'xlarge'],

            init() {
                this.loadPreferences();
                this.addControls();
                this.bindEvents();
            },

            loadPreferences() {
                const savedTheme = localStorage.getItem('ikey_theme') || 'default';
                const savedSize = localStorage.getItem('ikey_text_size') || 'normal';
                this.applyTheme(savedTheme);
                this.applySize(savedSize);
            },

            applyTheme(theme) {
                document.body.className = document.body.className
                    .replace(/theme-\w+/, '')
                    .trim() + ' theme-' + theme;
                localStorage.setItem('ikey_theme', theme);
                this.applyThemeSpecifics(theme);
            },

            applySize(size) {
                document.body.className = document.body.className
                    .replace(/size-\w+/, '')
                    .trim() + ' size-' + size;
                localStorage.setItem('ikey_text_size', size);
            },

            applyThemeSpecifics(theme) {
                const lock = document.getElementById('lockText');
                if (lock) lock.textContent = 'PIN Protected';
                if (theme === 'topsecret') {
                    document.querySelectorAll('.timestamp').forEach(el => {
                        const date = new Date(el.textContent);
                        el.textContent = date.toLocaleTimeString('en-US', {
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit'
                        }) + 'hrs';
                    });
                    if (lock) lock.textContent = 'CLEARANCE LEVEL: PUBLIC';
                    document.querySelectorAll('.security-badge').forEach(badge => {
                        badge.textContent = badge.textContent.replace('PIN Protected', 'LEVEL 2 CLEARANCE');
                    });
                }
            },

            addControls() {
                const controlsHTML = `
            <div class="theme-controls">
                <h3>Appearance Settings</h3>

                <div class="form-group">
                    <label>Visual Theme</label>
                    <select id="theme-selector" class="theme-select">
                        <option value="default">Medical Professional</option>
                        <option value="topsecret">Top Secret</option>
                        <option value="hacker">Midnight Hacker</option>
                        <option value="wellness">Zen Wellness</option>
                        <option value="contrast">High Contrast</option>
                        <option value="retro">Retro Medical</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Text Size</label>
                    <div class="size-controls">
                        <button class="size-btn" data-size="small">A-</button>
                        <button class="size-btn" data-size="normal">A</button>
                        <button class="size-btn" data-size="large">A+</button>
                        <button class="size-btn" data-size="xlarge">A++</button>
                    </div>
                </div>
            </div>
        `;
                const securitySection = document.getElementById('security-section');
                if (securitySection) {
                    securitySection.insertAdjacentHTML('beforeend', controlsHTML);
                }
            },

            bindEvents() {
                document.getElementById('theme-selector')?.addEventListener('change', (e) => {
                    this.applyTheme(e.target.value);
                });

                document.querySelectorAll('.size-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.applySize(btn.dataset.size);
                    });
                });
            }
        };

        // Initialize Application
        async function init() {
            const fragment = window.location.hash.slice(1);
            if (fragment) {
                const [guid, keyB64] = fragment.split(':');
                if (guid && keyB64) {
                    try {
                        state.currentGUID = guid;
                        state.baseKey = Uint8Array.from(atob(keyB64), c => c.charCodeAt(0));
                        state.isShareMode = true;
                        document.body.classList.add('share-mode');

                await restoreFromCloud(guid, state.baseKey);
                displayEmergencyInfo();
                return; // STOP HERE - don't load localStorage
            } catch (error) {
                console.error('Hash access failed:', error);
                showStatus('Unable to load emergency data', 'error');
                window.location.hash = '';
                showSetupWizard();
                return;
            }
        }
    }
    
    // Only check localStorage if NO hash in URL
    const hasGUID = localStorage.getItem('ikey_guid');
    
    if (!hasGUID) {
        // No saved instance and no hash - show wizard
        state.isFirstTime = true;
        showSetupWizard();
    } else {
        // Load the saved instance ONLY if no hash
        await loadExistingUser();
    }

    // Setup keyboard listeners and activity tracking
    setupKeyboardListeners();
    ['mousemove','keypress','click','touchstart','scroll'].forEach(evt => {
        document.addEventListener(evt, trackActivity, { passive: true });
    });
    trackActivity();
}

        function switchInstance() {
            const instances = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('ikey_') && key.endsWith('_public')) {
                    const guid = key.replace('ikey_', '').replace('_public', '');
                    instances.push(guid);
                }
            }
            if (instances.length > 1) {
                const choice = confirm('Multiple medical profiles detected.\nWould you like to switch profiles?');
                if (choice) {
                    const selected = prompt(
                        'Enter profile number:\n' +
                        instances.map((g, i) => `${i + 1}: ${g.substring(0, 8)}...`).join('\n')
                    );
                    if (selected) {
                        const idx = parseInt(selected) - 1;
                        if (instances[idx]) {
                            state.currentGUID = instances[idx];
                            loadExistingUser();
                        }
                    }
                }
            }
        }

        function createNewInstance() {
            if (confirm('Create a new medical profile? Current data will be preserved.')) {
                state.currentGUID = null;
                state.baseKey = null;
                state.pinKey = null;
                state.passwordKey = null;
                state.pinUnlocked = false;
                state.passwordUnlocked = false;
                window.location.hash = '';
                showSetupWizard();
            }
        }

        function clearCurrentInstance() {
            if (state.currentGUID) {
                if (confirm('Clear this profile from browser? (Cloud backup remains)')) {
                    localStorage.removeItem(`ikey_guid`);
                    localStorage.removeItem(`ikey_basekey_${state.currentGUID}`);
                    localStorage.removeItem(`ikey_${state.currentGUID}_public`);
                    localStorage.removeItem(`ikey_${state.currentGUID}_protected`);
                    localStorage.removeItem(`ikey_${state.currentGUID}_secure`);
                    localStorage.removeItem(`ikey_hash_${state.currentGUID}`);
                    localStorage.removeItem(`ikey_pin_temp_${state.currentGUID}`);
                    window.location.hash = '';
                    location.reload();
                }
            }
        }

        // Keyboard Support for PIN Entry
        function setupKeyboardListeners() {
            document.addEventListener('keydown', function(e) {
                // Handle keyboard only when PIN modal is active
                const pinModal = document.getElementById('pin-modal');

                if (pinModal.classList.contains('active')) {
                    // Handle number keys 0-9
                    if (e.key >= '0' && e.key <= '9') {
                        e.preventDefault();
                        const digit = parseInt(e.key);
                        addPinDigit(digit);
                    }
                    // Handle backspace/delete
                    else if (e.key === 'Backspace' || e.key === 'Delete') {
                        e.preventDefault();
                        clearPin();
                    }
                    // Handle Enter
                    else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (pinEntry.length === 6) {
                            verifyPIN();
                        }
                    }
                    // Handle Escape
                    else if (e.key === 'Escape') {
                        e.preventDefault();
                        closePinPad();
                    }
                }
            });
        }

        function trackActivity() {
            state.lastActivity = Date.now();
            resetLogoutTimer();
        }

        function resetLogoutTimer() {
            clearTimeout(state.logoutTimer);
            clearTimeout(state.logoutWarningTimer);

            state.logoutWarningTimer = setTimeout(() => {
                if (confirm('Session expiring in 5 minutes. Continue?')) {
                    trackActivity();
                }
            }, AUTO_LOGOUT_MS - (5 * 60 * 1000));

            state.logoutTimer = setTimeout(() => {
                if (Date.now() - state.lastActivity > AUTO_LOGOUT_MS) {
                    autoLogout();
                }
            }, AUTO_LOGOUT_MS);
        }

        function autoLogout() {
            state.pinUnlocked = false;
            state.passwordUnlocked = false;
            state.pinKey = null;
            state.passwordKey = null;
            state.currentDoubleHash = null;  // Clear from memory
            pinEntry = '';
            localStorage.removeItem(`ikey_pin_temp_${state.currentGUID}`);
            updateSecurityUI();
            showStatus('Session expired for security', 'warning');
            showTab('emergency');
            trackActivity();
        }

        // Webhook Functions
        async function syncToCloud(showIndicator = true) {
            if (!state.baseKey) return;

            // Load encrypted hash if not in memory
            if (!state.currentDoubleHash) {
                try {
                    const stored = localStorage.getItem(`ikey_hash_${state.currentGUID}`);
                    if (stored) {
                        const decrypted = await decrypt(stored, state.baseKey);
                        state.currentDoubleHash = decrypted.hash;
                    }
                } catch (e) {
                    showStatus('Please enter PIN to enable sync', 'error');
                    return;
                }
            }

            if (!state.currentDoubleHash) {
                showStatus('Authentication required for sync', 'error');
                return;
            }

            if (showIndicator) {
                const syncIndicator = document.getElementById('syncIndicator');
                syncIndicator.style.display = 'flex';
                syncIndicator.classList.add('sync-indicator');
                document.getElementById('syncText').textContent = 'Syncing...';
            }

            try {
                const timestamp = new Date().toISOString();
                // Combine all tiers into a single payload
                const allData = {
                    version: APP_VERSION,
                    timestamp,
                    public: state.publicData,
                    protected: state.pinKey ? state.protectedData : null,
                    secure: state.passwordKey ? state.secureData : null
                };

                // Encrypt entire payload with base key
                const encryptedPayload = await encrypt(allData, state.baseKey);

                // Generate new double hash for next update
                const salt = Date.now().toString();
                const storedPin = localStorage.getItem(`ikey_pin_temp_${state.currentGUID}`) || '';
                const newDoubleHash = await generateDoubleHash(state.baseKey, storedPin, salt);

                // Prepare sync data with both hashes for webhook
                const syncData = {
                    guid: state.currentGUID,
                    currentHash: state.currentDoubleHash,
                    nextHash: newDoubleHash,
                    data: encryptedPayload,
                    timestamp,
                    method: state.lastSync ? 'update' : 'create'
                };

                const method = state.lastSync ? 'PUT' : 'POST';

                const webhookRequest = fetch(WEBHOOK_URL, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(syncData)
                });

                const cachePayload = {
                    guid: state.currentGUID,
                    ikey_cache: encryptedPayload,
                    timestamp,
                    version: APP_VERSION
                };

                const xanoRequest = fetch(XANO_CACHE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cachePayload)
                });

                const [webhookResult, xanoResult] = await Promise.allSettled([webhookRequest, xanoRequest]);

                const results = { webhook: false, xano: false };

                if (webhookResult.status === 'fulfilled') {
                    if (webhookResult.value.ok) {
                        results.webhook = true;
                    } else if (webhookResult.value.status === 403) {
                        throw new Error('Authentication failed');
                    } else {
                        throw new Error(`Webhook HTTP ${webhookResult.value.status}`);
                    }
                } else {
                    throw new Error('Webhook request failed');
                }

                if (xanoResult.status === 'fulfilled' && xanoResult.value.ok) {
                    results.xano = true;
                }

                // Success - rotate to new hash
                state.currentDoubleHash = newDoubleHash;
                const encryptedHash = await encrypt({ hash: newDoubleHash }, state.baseKey);
                localStorage.setItem(`ikey_hash_${state.currentGUID}`, encryptedHash);

                state.lastSync = timestamp;
                localStorage.setItem(`ikey_${state.currentGUID}_lastSync`, state.lastSync);

                if (showIndicator) {
                    document.getElementById('syncText').textContent = 'Synced';
                    setTimeout(() => {
                        document.getElementById('syncIndicator').style.display = 'none';
                    }, 2000);
                }

                state.telemetry.lastSyncResults = results;

                if (!results.xano) {
                    showStatus('Synced (cache update failed)', 'warning');
                } else {
                    showStatus('Data synced to cloud', 'success');
                }

            } catch (error) {
                console.error('Sync failed:', error);

                if (showIndicator) {
                    document.getElementById('syncText').textContent = 'Sync Failed';
                    setTimeout(() => {
                        document.getElementById('syncIndicator').style.display = 'none';
                    }, 3000);
                }

                if (error.message.includes('Authentication failed')) {
                    handleAuthFailure();
                } else {
                    showStatus('Cloud sync failed - data saved locally', 'error');
                }
            }
        }

        async function handleAuthFailure() {
            alert(
                'Sync authentication failed.\n\n' +
                'Recovery is not available in this version.'
            );
        }

        // Setup Wizard Functions
        function showSetupWizard() {
            document.getElementById('setup-wizard').classList.remove('hidden');
            updateWizardProgress(1);
        }

        function updateWizardProgress(step) {
            document.querySelectorAll('.wizard-step').forEach(s => {
                s.classList.remove('active');
                if (s.dataset.step == step) {
                    s.classList.add('active');
                }
            });
            
            document.querySelectorAll('.progress-step').forEach((s, index) => {
                s.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    s.classList.add('completed');
                } else if (index + 1 == step) {
                    s.classList.add('active');
                }
            });
            
            // Update buttons
            document.getElementById('wizard-back').style.display = step === 1 ? 'none' : 'block';
            document.getElementById('wizard-next').style.display = step === 4 ? 'none' : 'block';
            document.getElementById('wizard-complete').classList.toggle('hidden', step !== 4);
        }

        let currentWizardStep = 1;

        function wizardNext() {
            if (validateWizardStep(currentWizardStep)) {
                currentWizardStep++;
                updateWizardProgress(currentWizardStep);

                if (currentWizardStep === 4) {
                    generateSetupQR(true);
                }
            }
        }

        function wizardBack() {
            if (currentWizardStep > 1) {
                currentWizardStep--;
                updateWizardProgress(currentWizardStep);
            }
        }

        function validateWizardStep(step) {
            if (step === 2) {
                const name = document.getElementById('setup-name').value;
                const contactName = document.getElementById('setup-contact-name').value;
                const contactPhone = document.getElementById('setup-contact-phone').value;
                const contactRelationship = document.getElementById('setup-contact-relationship').value;

                if (!name) {
                    alert('Please enter your name');
                    return false;
                }
                if (!contactName || !contactPhone || !contactRelationship) {
                    alert('Please complete all emergency contact fields');
                    return false;
                }
                if (contactRelationship === 'other' && !document.getElementById('setup-contact-other').value) {
                    alert('Please specify the relationship');
                    return false;
                }
            }
            if (step === 3) {
                const pin = document.getElementById('setup-pin').value;
                const healthPass = document.getElementById('setup-health-password').value;
                if (!pin || pin.length !== 6) {
                    alert('Please enter a 6-digit PIN');
                    return false;
                }
                try {
                    validateHealthPassword(healthPass);
                } catch (e) {
                    alert(e.message);
                    return false;
                }
            }
            return true;
        }

        async function completeSetup() {
            // Show processing overlay
            const wizardContainer = document.querySelector('.wizard-container');
            const processingOverlay = document.createElement('div');
            processingOverlay.className = 'processing-overlay';
            processingOverlay.innerHTML = `
                <div style="text-align: center;">
                    <div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
                    <div class="processing-message">Setting up your secure vault...</div>
                </div>
            `;
            wizardContainer.appendChild(processingOverlay);
            
            // Update button to show loading state
            const completeBtn = document.getElementById('wizard-complete');
            completeBtn.disabled = true;
            completeBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';
            
            // Add small delay so user sees the animation
            await new Promise(resolve => setTimeout(resolve, 500));
            
            try {
                // Update processing message
                processingOverlay.querySelector('.processing-message').textContent = 'Generating encryption keys...';
                
                // Generate GUID and keys
                state.currentGUID = generateGUID();
                state.baseKey = await generateKey();
                
                // Update message
                processingOverlay.querySelector('.processing-message').textContent = 'Encrypting your data...';
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Save emergency data
                state.publicData.emergency = {
                    name: document.getElementById('setup-name').value,
                    bloodType: document.getElementById('setup-blood').value,
                    allergies: document.getElementById('setup-allergies').value,
                    medications: document.getElementById('setup-medications').value,
                    conditions: document.getElementById('setup-conditions').value,
                    contactName: document.getElementById('setup-contact-name').value,
                    contactPhone: document.getElementById('setup-contact-phone').value,
                    contactRelationship: document.getElementById('setup-contact-relationship').value,
                    contactOther: document.getElementById('setup-contact-other').value
                };
                
                const pin = document.getElementById('setup-pin').value;
                const healthPassword = document.getElementById('setup-health-password').value;

                if (pin && pin.length === 6) {
                    state.pinKey = await deriveKeyFromPIN(pin);
                    state.pinUnlocked = true;
                    localStorage.setItem(`ikey_pin_temp_${state.currentGUID}`, pin);

                    state.currentDoubleHash = await generateDoubleHash(state.baseKey, pin);
                    const encryptedHash = await encrypt({ hash: state.currentDoubleHash }, state.baseKey);
                    localStorage.setItem(`ikey_hash_${state.currentGUID}`, encryptedHash);
                }

                if (healthPassword && healthPassword.length >= 12) {
                    state.passwordKey = await deriveKeyFromPassword(healthPassword);
                    state.passwordUnlocked = true;
                    state.secureData.ehr = initializeEHR();
                }

                // Update message
                processingOverlay.querySelector('.processing-message').textContent = 'Generating recovery codes...';
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Generate recovery codes
                state.protectedData.recoveryCodes = generateRecoveryCodes();

                // Save everything
                localStorage.setItem('ikey_guid', state.currentGUID);
                localStorage.setItem(`ikey_basekey_${state.currentGUID}`,
                    btoa(String.fromCharCode(...state.baseKey)));

                // Update message
                processingOverlay.querySelector('.processing-message').textContent = 'Syncing to cloud...';
                
                await saveAllData();
                await downloadKeyFile();
                
                // Final message
                processingOverlay.querySelector('.processing-message').textContent = '✓ Setup complete!';
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Hide wizard and show main app
                document.getElementById('setup-wizard').classList.add('hidden');
                await loadExistingUser();
                
            } catch (error) {
                console.error('Setup failed:', error);
                processingOverlay.innerHTML = `
                    <div style="text-align: center; color: var(--danger);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">⚠️</div>
                        <div class="processing-message">Setup failed. Please try again.</div>
                    </div>
                `;
                
                // Re-enable button
                completeBtn.disabled = false;
                completeBtn.innerHTML = 'Start Using iKey';
                
                setTimeout(() => {
                    processingOverlay.remove();
                }, 3000);
            }
        }

        function generateSetupQR(autoDownload = false) {
            if (typeof QRCode === 'undefined') {
                setTimeout(() => generateSetupQR(autoDownload), 100);
                return;
            }

            const qrData = `${APP_URL}#${state.currentGUID}:${encodeURIComponent(btoa(String.fromCharCode(...state.baseKey)))}`;

            const container = document.getElementById('setup-qrcode');
            container.innerHTML = '';

            new QRCode(container, {
                text: qrData,
                width: 256,
                height: 256,
                correctLevel: QRCode.CorrectLevel.M
            });

            if (autoDownload) {
                setTimeout(downloadSetupQR, 100);
            }
        }

        function downloadSetupQR() {
            const canvas = document.querySelector('#setup-qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'ikey-emergency-qr.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        // Load existing user
        async function loadExistingUser() {
            state.currentGUID = localStorage.getItem('ikey_guid');
            state.lastSync = localStorage.getItem(`ikey_${state.currentGUID}_lastSync`);

            const baseKeyStr = localStorage.getItem(`ikey_basekey_${state.currentGUID}`);
            if (baseKeyStr) {
                state.baseKey = Uint8Array.from(atob(baseKeyStr), c => c.charCodeAt(0));
            }

            // Load encrypted double hash
            try {
                const storedHash = localStorage.getItem(`ikey_hash_${state.currentGUID}`);
                if (storedHash && state.baseKey) {
                    const decrypted = await decrypt(storedHash, state.baseKey);
                    state.currentDoubleHash = decrypted.hash;
                }
            } catch (e) {
                console.log('No stored hash found');
            }

            await loadPublicData();
            displayEmergencyInfo();

            // Update UI based on what's unlocked
            updateSecurityUI();
        }

        // Utility Functions
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function generateKey() {
            return crypto.getRandomValues(new Uint8Array(32));
        }

        async function deriveKeyFromPIN(pin) {
            const encoder = new TextEncoder();
            const pinData = encoder.encode(pin + state.currentGUID);
            
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                pinData,
                { name: 'PBKDF2' },
                false,
                ['deriveBits']
            );
            
            const derivedBits = await crypto.subtle.deriveBits(
                {
                    name: 'PBKDF2',
                    salt: encoder.encode(state.currentGUID),
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                256
            );
            
            return new Uint8Array(derivedBits);
        }

        async function deriveKeyFromPassword(password) {
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(password + state.currentGUID);
            
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                passwordData,
                { name: 'PBKDF2' },
                false,
                ['deriveBits']
            );
            
            const derivedBits = await crypto.subtle.deriveBits(
                {
                    name: 'PBKDF2',
                    salt: encoder.encode(state.currentGUID + 'secure'),
                    iterations: 200000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                256
            );
            
            return new Uint8Array(derivedBits);
        }

        async function generateDoubleHash(baseKey, pin, salt = '') {
            const combined = btoa(String.fromCharCode(...baseKey)) + pin + salt;
            const encoder = new TextEncoder();
            const firstHash = await crypto.subtle.digest('SHA-256', encoder.encode(combined));
            const secondHash = await crypto.subtle.digest('SHA-256', firstHash);
            return btoa(String.fromCharCode(...new Uint8Array(secondHash)));
        }

        function generateRecoveryCodes() {
            const codes = [];
            for (let i = 0; i < 6; i++) {
                codes.push(Math.random().toString(36).substring(2, 8).toUpperCase());
            }
            return codes;
        }

        async function deriveKeyFromURL(url) {
            const encoder = new TextEncoder();
            const data = encoder.encode(url);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return new Uint8Array(hash);
        }

        async function downloadKeyFile() {
            if (!state.baseKey || !state.currentGUID) return;
            const urlKey = await deriveKeyFromURL(APP_URL);
            const keyData = {
                guid: state.currentGUID,
                baseKey: btoa(String.fromCharCode(...state.baseKey))
            };
            const encrypted = await encrypt(keyData, urlKey);
            const blob = new Blob([encrypted], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ikey-key-${state.currentGUID}.ikey`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Recovery key file downloaded. Keep it secure for alternate login.');
        }

        async function refreshBaseKey() {
            state.baseKey = await generateKey();
            localStorage.setItem(`ikey_basekey_${state.currentGUID}`,
                btoa(String.fromCharCode(...state.baseKey)));
            const storedPin = localStorage.getItem(`ikey_pin_temp_${state.currentGUID}`) || '';
            if (storedPin) {
                state.currentDoubleHash = await generateDoubleHash(state.baseKey, storedPin);
                const encryptedHash = await encrypt({ hash: state.currentDoubleHash }, state.baseKey);
                localStorage.setItem(`ikey_hash_${state.currentGUID}`, encryptedHash);
            }
            await saveAllData();
            await downloadKeyFile();
        }

        // Encryption/Decryption
        async function encrypt(data, key) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encoded = new TextEncoder().encode(JSON.stringify(data));

            const cryptoKey = await crypto.subtle.importKey(
                'raw', key, { name: 'AES-GCM' }, false, ['encrypt']
            );

            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv }, cryptoKey, encoded
            );

            const ivStr = btoa(String.fromCharCode(...iv));
            const dataStr = btoa(String.fromCharCode(...new Uint8Array(encrypted)));
            return `${ivStr}.${dataStr}`;
        }

        async function decrypt(combined, key) {
            try {
                const [ivStr, dataStr] = combined.split('.');
                if (!ivStr || !dataStr) throw new Error('Invalid encrypted format');
                const iv = Uint8Array.from(atob(ivStr), c => c.charCodeAt(0));
                const data = Uint8Array.from(atob(dataStr), c => c.charCodeAt(0));

                const cryptoKey = await crypto.subtle.importKey(
                    'raw', key, { name: 'AES-GCM' }, false, ['decrypt']
                );

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv }, cryptoKey, data
                );

                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (error) {
                console.error('Decryption failed:', error);
                throw error;
            }
        }

        async function fetchWithRetry(url, options = {}, retries = 2, backoff = 500) {
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (err) {
                    if (attempt === retries) throw err;
                    await new Promise(res => setTimeout(res, backoff * Math.pow(2, attempt)));
                }
            }
        }

        // Data Loading/Saving
        async function restoreFromCloud(guid, baseKey) {
            const sources = [
                {
                    name: 'Xano',
                    url: `${XANO_CACHE_URL}?guid=${guid}`,
                    extract: r => r?.ikey_cache
                },
                {
                    name: 'Archive.org',
                    url: `${ARCHIVE_BASE_URL}/${guid}.json`,
                    extract: r => r?.ikey_cache
                },
                {
                    name: 'Webhook',
                    url: `${WEBHOOK_URL}?guid=${guid}`,
                    extract: r => r?.data
                }
            ];

            for (const src of sources) {
                try {
                    const json = await fetchWithRetry(src.url);
                    const payload = src.extract(json);
                    if (!payload) throw new Error('Invalid payload');
                    const allData = await decrypt(payload, baseKey);

                    state.publicData = allData.public || {};
                    await savePublicData();

                    if (state.pinKey && allData.protected) {
                        state.protectedData = allData.protected;
                        await saveProtectedData();
                    }

                    if (state.passwordKey && allData.secure) {
                        state.secureData = allData.secure;
                        await saveSecureData();
                    }

                    state.telemetry.lastRestoreSource = src.name;
                    showStatus(`Data restored from ${src.name}`, 'success');
                    return allData;
                } catch (err) {
                    console.warn(`${src.name} retrieval failed`, err);
                }
            }

            showStatus('Unable to retrieve data', 'error');
            return null;
        }

        async function loadPublicData() {
            try {
                const stored = localStorage.getItem(`ikey_${state.currentGUID}_public`);
                if (stored && state.baseKey) {
                    state.publicData = await decrypt(stored, state.baseKey);
                }
            } catch (error) {
                console.error('Failed to load public data:', error);
            }
        }

        async function loadProtectedData() {
            try {
                const stored = localStorage.getItem(`ikey_${state.currentGUID}_protected`);
                if (stored && state.pinKey) {
                    state.protectedData = await decrypt(stored, state.pinKey);
                    loadHealthInfo();
                }
            } catch (error) {
                console.error('Failed to load protected data:', error);
            }
        }

        async function loadSecureData() {
            try {
                const stored = localStorage.getItem(`ikey_${state.currentGUID}_secure`);
                if (stored && state.passwordKey) {
                    state.secureData = await decrypt(stored, state.passwordKey);
                    if (!state.secureData.ehr) {
                        state.secureData.ehr = initializeEHR();
                    }
                    loadEHRData();
                }
            } catch (error) {
                console.error('Failed to load secure data:', error);
                state.secureData = { ehr: initializeEHR() };
            }
        }

        async function savePublicData() {
            if (!state.baseKey) return;
            // encrypt returns "IV.EncryptedData" format directly
            const encrypted = await encrypt(state.publicData, state.baseKey);
            localStorage.setItem(`ikey_${state.currentGUID}_public`, encrypted);
        }

        async function saveProtectedData() {
            if (!state.pinKey) return;
            // encrypt returns "IV.EncryptedData" format directly
            const encrypted = await encrypt(state.protectedData, state.pinKey);
            localStorage.setItem(`ikey_${state.currentGUID}_protected`, encrypted);
        }

        async function saveSecureData() {
            if (!state.passwordKey) return;
            // encrypt returns "IV.EncryptedData" format directly
            const encrypted = await encrypt(state.secureData, state.passwordKey);
            localStorage.setItem(`ikey_${state.currentGUID}_secure`, encrypted);
        }

        async function saveAllData() {
            await savePublicData();
            if (state.pinKey) await saveProtectedData();
            if (state.passwordKey) await saveSecureData();
            showStatus('All data saved', 'success');

            // Sync single encrypted blob to cloud
            await syncToCloud();
        }

        // Auto-save function
        function triggerAutoSave() {
            clearTimeout(state.autoSaveTimer);
            state.autoSaveTimer = setTimeout(async () => {
                await saveAllData();
                showStatus('Auto-saved', 'success');
            }, 2000);
        }

        // Display Functions
        function handleRelationshipChange(context) {
            const select = document.getElementById(`${context}-contact-relationship`);
            const otherGroup = document.getElementById(`${context}-other-relationship-group`);

            if (select && otherGroup) {
                if (select.value === 'other') {
                    otherGroup.style.display = 'block';
                } else {
                    otherGroup.style.display = 'none';
                    const otherInput = document.getElementById(`${context}-contact-other`);
                    if (otherInput) otherInput.value = '';
                }
            }
        }

        function displayEmergencyInfo() {
            const container = document.getElementById('emergency-display');
            const data = state.publicData.emergency || {};

            let relationshipDisplay = 'Not specified';
            if (data.contactRelationship) {
                const relationships = {
                    'spouse': 'Spouse/Partner',
                    'parent': 'Parent',
                    'child': 'Child',
                    'sibling': 'Sibling',
                    'case-manager': 'Case Manager',
                    'employer': 'Employer',
                    'friend': 'Friend',
                    'prefer-not': 'Prefer not to say',
                    'other': data.contactOther || 'Other'
                };
                relationshipDisplay = relationships[data.contactRelationship] || data.contactRelationship;
            }

            container.innerHTML = `
                <div class="info-card">
                    <span class="info-card-icon">👤</span>
                    <div class="info-card-content">
                        <div class="info-card-label">NAME</div>
                        <div class="info-card-value">${data.name || 'Not set'}</div>
                    </div>
                </div>

                <div class="info-card">
                    <span class="info-card-icon">🩸</span>
                    <div class="info-card-content">
                        <div class="info-card-label">BLOOD TYPE</div>
                        <div class="info-card-value">${data.bloodType || 'Unknown'}</div>
                    </div>
                </div>

                <div class="info-card">
                    <span class="info-card-icon">⚠️</span>
                    <div class="info-card-content">
                        <div class="info-card-label">ALLERGIES</div>
                        <div class="info-card-value">${data.allergies || 'None reported'}</div>
                    </div>
                </div>

                <div class="info-card">
                    <span class="info-card-icon">💊</span>
                    <div class="info-card-content">
                        <div class="info-card-label">MEDICATIONS</div>
                        <div class="info-card-value">${data.medications || 'None reported'}</div>
                    </div>
                </div>

                <div class="info-card">
                    <span class="info-card-icon">🏥</span>
                    <div class="info-card-content">
                        <div class="info-card-label">CONDITIONS</div>
                        <div class="info-card-value">${data.conditions || 'None reported'}</div>
                    </div>
                </div>

                <div class="info-card">
                    <span class="info-card-icon">📞</span>
                    <div class="info-card-content">
                        <div class="info-card-label">EMERGENCY CONTACT</div>
                        <div class="info-card-value">
                            ${data.contactName || 'Not set'}<br>
                            <small style="color: var(--text-secondary);">
                                ${data.contactPhone || 'No phone'} • ${relationshipDisplay}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }

        // PIN Management
        let pinCallback = null;

        function requestPINForSetup() {
            pinCallback = 'setup';
            document.getElementById('pin-modal').classList.add('active');
            document.getElementById('pin-modal-title').textContent = 'Set Your 6-Digit PIN';
            pinEntry = '';
            updatePinDisplay();
        }

        function requestPIN(action) {
            if (state.pinUnlocked && action !== 'change' && action !== 'setup') {
                if (action === 'edit') editEmergencyInfo();
                return;
            }

            pinCallback = action;
            document.getElementById('pin-modal').classList.add('active');
            document.getElementById('pin-modal-title').textContent = action === 'setup'
                ? 'Set 6-Digit PIN'
                : 'Enter 6-Digit PIN';
            pinEntry = '';
            updatePinDisplay();
        }

        function addPinDigit(digit) {
            if (pinEntry.length < 6) {
                pinEntry += digit;
                updatePinDisplay();

                if (pinEntry.length === 6) {
                    setTimeout(verifyPIN, 100);
                }
            }
        }

        function clearPin() {
            pinEntry = '';
            updatePinDisplay();
        }

        function closePinPad() {
            document.getElementById('pin-modal').classList.remove('active');
            pinEntry = '';
            pinCallback = null;
        }

        function updatePinDisplay() {
            const dots = document.querySelectorAll('#pinDisplay .pin-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < pinEntry.length);
                dot.classList.remove('error');
            });
        }

        async function verifyPIN() {
            if (pinCallback === 'setup') {
                document.getElementById('setup-pin').value = pinEntry;
                document.getElementById('setup-pin-display').style.display = 'block';
                closePinPad();
                return;
            }
            try {
                const derivedKey = await deriveKeyFromPIN(pinEntry);
                
                // Try to decrypt protected data
                const stored = localStorage.getItem(`ikey_${state.currentGUID}_protected`);
                
                if (!stored) {
                    // First time setting PIN
                    state.pinKey = derivedKey;
                    state.pinUnlocked = true;
                    localStorage.setItem(`ikey_pin_temp_${state.currentGUID}`, pinEntry);
                    state.protectedData = {
                        health: {}
                    };
                    await saveProtectedData();
                    unlockPINLevel();
                    closePinPad();
                    showStatus('PIN set successfully', 'success');
                    return;
                }
                
                // Try to decrypt
                const decrypted = await decrypt(stored, derivedKey);
                state.pinKey = derivedKey;
                state.protectedData = decrypted;
                state.pinUnlocked = true;
                localStorage.setItem(`ikey_pin_temp_${state.currentGUID}`, pinEntry);

                // Regenerate and store double hash with verified PIN
                state.currentDoubleHash = await generateDoubleHash(state.baseKey, pinEntry);
                const encryptedHash = await encrypt({ hash: state.currentDoubleHash }, state.baseKey);
                localStorage.setItem(`ikey_hash_${state.currentGUID}`, encryptedHash);

                unlockPINLevel();
                closePinPad();
                await loadProtectedData();
                state.pinAttemptsRemaining = 5;

                if (pinCallback === 'change') {
                    await refreshBaseKey();
                    showStatus('PIN changed successfully', 'success');
                }

                if (pinCallback === 'edit') {
                    editEmergencyInfo();
                }
                
            } catch (error) {
                // Wrong PIN
                state.pinAttemptsRemaining--;
                showStatus(`Wrong PIN. ${state.pinAttemptsRemaining} attempts remaining`, 'error');
                document.querySelectorAll('#pinDisplay .pin-dot').forEach(dot => dot.classList.add('error'));
                setTimeout(() => {
                    pinEntry = '';
                    updatePinDisplay();
                }, 1000);
            }
        }

        function unlockPINLevel() {
            updateSecurityUI();
        }

        // Password Management
        function requestPassword(action) {
            document.getElementById('password-modal').classList.add('active');
            document.getElementById('password-modal').dataset.action = action;
            
            if (action === 'unlock') {
                document.getElementById('password-title').textContent = 'Enter Password to Unlock EHR';
                document.getElementById('confirm-group').style.display = 'none';
            } else {
                document.getElementById('password-title').textContent = 'Set Password for Full EHR';
                document.getElementById('confirm-group').style.display = 'block';
            }
        }

        function showPasswordManager() {
            if (state.passwordUnlocked) {
                if (confirm('Change your EHR password?')) {
                    requestPassword('change');
                }
            } else {
                requestPassword('set');
            }
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('active');
            document.getElementById('password-input').value = '';
            document.getElementById('confirm-password').value = '';
        }

        function validateHealthPassword(password) {
            if (password.length < 12) {
                throw new Error('Password must be at least 12 characters');
            }
            const checks = {
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password)
            };
            if (!checks.uppercase || !checks.lowercase || !checks.number) {
                throw new Error('Password must include uppercase, lowercase, and numbers');
            }
            return true;
        }

        async function submitPassword() {
            const action = document.getElementById('password-modal').dataset.action;
            const password = document.getElementById('password-input').value;
            const confirm = document.getElementById('confirm-password').value;

            try {
                validateHealthPassword(password);
            } catch (e) {
                alert(e.message);
                return;
            }
            
            if (action !== 'unlock' && password !== confirm) {
                alert('Passwords do not match');
                return;
            }
            
            try {
                const derivedKey = await deriveKeyFromPassword(password);
                
                if (action === 'unlock') {
                    // Try to decrypt
                    const stored = localStorage.getItem(`ikey_${state.currentGUID}_secure`);
                    if (stored) {
                        const decrypted = await decrypt(stored, derivedKey);
                        state.passwordKey = derivedKey;
                        state.secureData = decrypted;
                        state.passwordUnlocked = true;
                        unlockPasswordLevel();
                        closePasswordModal();
                        showStatus('EHR unlocked', 'success');
                    } else {
                        alert('No EHR data found');
                    }
                } else {
                    // Set new password
                    state.passwordKey = derivedKey;
                    state.passwordUnlocked = true;
                    if (!state.secureData.ehr) {
                        state.secureData.ehr = initializeEHR();
                    }
                    await saveSecureData();
                    unlockPasswordLevel();
                    closePasswordModal();
                    await refreshBaseKey();
                    showStatus(action === 'change' ? 'Password changed successfully' : 'Password set successfully', 'success');
                }
            } catch (error) {
                alert('Failed to process password');
            }
        }

        function unlockPasswordLevel() {
            updateSecurityUI();
            loadEHRData();
        }

        // Password strength indicator
        document.addEventListener('DOMContentLoaded', function() {
            const setupPassword = document.getElementById('setup-health-password');
            const mainPassword = document.getElementById('password-input');
            
            if (setupPassword) {
                setupPassword.addEventListener('input', (e) => checkPasswordStrength(e.target));
            }
            
            if (mainPassword) {
                mainPassword.addEventListener('input', (e) => checkPasswordStrength(e.target));
            }
        });

        function checkPasswordStrength(input) {
            const password = input.value;
            const bars = input.parentElement.querySelectorAll('.strength-bar');
            
            bars.forEach(bar => bar.className = 'strength-bar');
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password) && /[^a-zA-Z0-9]/.test(password)) strength++;
            
            const colors = ['weak', 'weak', 'medium', 'active'];
            for (let i = 0; i < strength; i++) {
                bars[i].classList.add(colors[Math.min(strength - 1, 2)]);
            }
        }

        // Edit Emergency Info
        function editEmergencyInfo() {
            const data = state.publicData.emergency || {};

            const container = document.getElementById('emergency-display');
            container.innerHTML = `
                <h3>Edit Emergency Information</h3>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-name" value="${data.name || ''}">
                </div>
                <div class="form-group">
                    <label>Blood Type</label>
                    <select id="edit-blood">
                        <option value="">Unknown</option>
                        <option value="A+" ${data.bloodType === 'A+' ? 'selected' : ''}>A+</option>
                        <option value="A-" ${data.bloodType === 'A-' ? 'selected' : ''}>A-</option>
                        <option value="B+" ${data.bloodType === 'B+' ? 'selected' : ''}>B+</option>
                        <option value="B-" ${data.bloodType === 'B-' ? 'selected' : ''}>B-</option>
                        <option value="AB+" ${data.bloodType === 'AB+' ? 'selected' : ''}>AB+</option>
                        <option value="AB-" ${data.bloodType === 'AB-' ? 'selected' : ''}>AB-</option>
                        <option value="O+" ${data.bloodType === 'O+' ? 'selected' : ''}>O+</option>
                        <option value="O-" ${data.bloodType === 'O-' ? 'selected' : ''}>O-</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Allergies</label>
                    <textarea id="edit-allergies">${data.allergies || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Current Medications</label>
                    <textarea id="edit-medications">${data.medications || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Medical Conditions</label>
                    <textarea id="edit-conditions">${data.conditions || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Emergency Contact Name</label>
                    <input type="text" id="edit-contact-name" value="${data.contactName || ''}">
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Contact Phone</label>
                        <input type="tel" id="edit-contact-phone" value="${data.contactPhone || ''}">
                    </div>

                    <div class="form-group">
                        <label>Relationship</label>
                        <select id="edit-contact-relationship" onchange="handleRelationshipChange('edit')">
                            <option value="">Select relationship</option>
                            <option value="spouse" ${data.contactRelationship === 'spouse' ? 'selected' : ''}>Spouse/Partner</option>
                            <option value="parent" ${data.contactRelationship === 'parent' ? 'selected' : ''}>Parent</option>
                            <option value="child" ${data.contactRelationship === 'child' ? 'selected' : ''}>Child</option>
                            <option value="sibling" ${data.contactRelationship === 'sibling' ? 'selected' : ''}>Sibling</option>
                            <option value="case-manager" ${data.contactRelationship === 'case-manager' ? 'selected' : ''}>Case Manager</option>
                            <option value="employer" ${data.contactRelationship === 'employer' ? 'selected' : ''}>Employer</option>
                            <option value="friend" ${data.contactRelationship === 'friend' ? 'selected' : ''}>Friend</option>
                            <option value="prefer-not" ${data.contactRelationship === 'prefer-not' ? 'selected' : ''}>Prefer not to answer</option>
                            <option value="other" ${data.contactRelationship === 'other' ? 'selected' : ''}>Other (specify)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="edit-other-relationship-group" style="display: ${data.contactRelationship === 'other' ? 'block' : 'none'};">
                    <label>Please specify relationship</label>
                    <input type="text" id="edit-contact-other" value="${data.contactOther || ''}">
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEmergencyInfo()">Save Changes</button>
                    <button class="btn btn-secondary" onclick="displayEmergencyInfo()">Cancel</button>
                </div>
            `;
        }

        async function saveEmergencyInfo() {
            state.publicData.emergency = {
                name: document.getElementById('edit-name').value,
                bloodType: document.getElementById('edit-blood').value,
                allergies: document.getElementById('edit-allergies').value,
                medications: document.getElementById('edit-medications').value,
                conditions: document.getElementById('edit-conditions').value,
                contactName: document.getElementById('edit-contact-name').value,
                contactPhone: document.getElementById('edit-contact-phone').value,
                contactRelationship: document.getElementById('edit-contact-relationship').value,
                contactOther: document.getElementById('edit-contact-other').value
            };

            await savePublicData();
            displayEmergencyInfo();
            showStatus('Emergency information saved', 'success');
        }

        // Health Info Management
        function loadHealthInfo() {
            const data = state.protectedData.health || {};
            document.getElementById('conditions').value = data.conditions || '';
            document.getElementById('surgeries').value = data.surgeries || '';
            document.getElementById('family-history').value = data.familyHistory || '';
            document.getElementById('health-notes').value = data.notes || '';
        }

        async function saveHealthInfo() {
            state.protectedData.health = {
                conditions: document.getElementById('conditions').value,
                surgeries: document.getElementById('surgeries').value,
                familyHistory: document.getElementById('family-history').value,
                notes: document.getElementById('health-notes').value
            };
            
            await saveProtectedData();
            showStatus('Health information saved', 'success');
        }

        // QR Code Generation
        function generateMainQR() {
            if (typeof QRCode === 'undefined') {
                showStatus('QR library loading...', 'info');
                setTimeout(generateMainQR, 500);
                return;
            }
            
            const qrData = `${APP_URL}#${state.currentGUID}:${encodeURIComponent(btoa(String.fromCharCode(...state.baseKey)))}`;
            
            document.getElementById('qr-display').classList.remove('hidden');
            const container = document.getElementById('main-qrcode');
            container.innerHTML = '';
            
            try {
                new QRCode(container, {
                    text: qrData,
                    width: 256,
                    height: 256,
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch (error) {
                showStatus('Failed to generate QR code', 'error');
            }
        }

        function downloadMainQR() {
            const canvas = document.querySelector('#main-qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'ikey-emergency-qr.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            if (!state.pinUnlocked && (tabName === 'health' || tabName === 'security')) {
                requestPIN('unlock');
                return;
            }

            if (!state.passwordUnlocked && tabName === 'ehr') {
                requestPassword('unlock');
                return;
            }
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // EHR Functions
        function initializeEHR() {
            return {
                identity: {},
                providers: [],
                medications: [],
                conditions: [],
                caseNotes: []
            };
        }

        function showEHRSection(section) {
            document.querySelectorAll('.ehr-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`ehr-${section}`).classList.add('active');
            
            document.querySelectorAll('.ehr-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function loadEHRData() {
            if (!state.secureData.ehr) return;
            
            // Load identity fields
            document.querySelectorAll('.ehr-data').forEach(input => {
                const field = input.dataset.field;
                if (state.secureData.ehr.identity && state.secureData.ehr.identity[field]) {
                    input.value = state.secureData.ehr.identity[field];
                }
            });
            
            // Load dynamic sections
            loadProviders();
            loadMedications();
            loadConditions();
            loadCaseNotes();
        }

        async function saveEHR() {
            if (!state.secureData.ehr) {
                state.secureData.ehr = initializeEHR();
            }
            
            // Save identity fields
            document.querySelectorAll('.ehr-data').forEach(input => {
                const field = input.dataset.field;
                if (!state.secureData.ehr.identity) state.secureData.ehr.identity = {};
                state.secureData.ehr.identity[field] = input.value;
            });
            
            // Save dynamic sections
            saveProviders();
            saveMedications();
            saveConditions();
            saveCaseNotes();
            
            await saveSecureData();
            showStatus('EHR saved successfully', 'success');
        }

        // Dynamic content functions
        function addProvider() {
            const container = document.getElementById('providers-container');
            const id = 'prov_' + Date.now();
            
            const html = `
                <div class="provider-card" data-provider-id="${id}">
                    <button class="delete-btn" onclick="removeProvider('${id}')">Remove</button>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Provider Name</label>
                            <input type="text" class="provider-field" data-id="${id}" data-field="name">
                        </div>
                        <div class="form-group">
                            <label>Specialty</label>
                            <input type="text" class="provider-field" data-id="${id}" data-field="specialty">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" class="provider-field" data-id="${id}" data-field="phone">
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeProvider(id) {
            document.querySelector(`[data-provider-id="${id}"]`).remove();
        }

        function saveProviders() {
            const providers = [];
            document.querySelectorAll('[data-provider-id]').forEach(card => {
                const provider = {};
                card.querySelectorAll('.provider-field').forEach(field => {
                    provider[field.dataset.field] = field.value;
                });
                providers.push(provider);
            });
            state.secureData.ehr.providers = providers;
        }

        function loadProviders() {
            const container = document.getElementById('providers-container');
            if (!container) return;
            
            container.innerHTML = '';
            const providers = state.secureData.ehr.providers || [];
            
            providers.forEach(provider => {
                addProvider();
                const card = container.lastElementChild;
                Object.keys(provider).forEach(field => {
                    const input = card.querySelector(`[data-field="${field}"]`);
                    if (input) input.value = provider[field];
                });
            });
        }

        // Similar functions for medications, conditions, case notes
        function addMedication() {
            const container = document.getElementById('medications-container');
            const id = 'med_' + Date.now();
            
            const html = `
                <div class="provider-card" data-med-id="${id}">
                    <button class="delete-btn" onclick="removeMedication('${id}')">Remove</button>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Medication</label>
                            <input type="text" class="med-field" data-id="${id}" data-field="name">
                        </div>
                        <div class="form-group">
                            <label>Dosage</label>
                            <input type="text" class="med-field" data-id="${id}" data-field="dosage">
                        </div>
                        <div class="form-group">
                            <label>Frequency</label>
                            <input type="text" class="med-field" data-id="${id}" data-field="frequency">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeMedication(id) {
            document.querySelector(`[data-med-id="${id}"]`).remove();
        }

        function saveMedications() {
            const medications = [];
            document.querySelectorAll('[data-med-id]').forEach(card => {
                const med = {};
                card.querySelectorAll('.med-field').forEach(field => {
                    med[field.dataset.field] = field.value;
                });
                medications.push(med);
            });
            state.secureData.ehr.medications = medications;
        }

        function loadMedications() {
            const container = document.getElementById('medications-container');
            if (!container) return;
            
            container.innerHTML = '';
            const medications = state.secureData.ehr.medications || [];
            
            medications.forEach(med => {
                addMedication();
                const card = container.lastElementChild;
                Object.keys(med).forEach(field => {
                    const input = card.querySelector(`[data-field="${field}"]`);
                    if (input) input.value = med[field];
                });
            });
        }

        function addCondition() {
            const container = document.getElementById('conditions-container');
            const id = 'cond_' + Date.now();
            
            const html = `
                <div class="provider-card" data-condition-id="${id}">
                    <button class="delete-btn" onclick="removeCondition('${id}')">Remove</button>
                    <div class="form-group">
                        <label>Condition</label>
                        <input type="text" class="condition-field" data-id="${id}" data-field="name">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Diagnosed</label>
                            <input type="date" class="condition-field" data-id="${id}" data-field="date">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="condition-field" data-id="${id}" data-field="status">
                                <option>Active</option>
                                <option>Managed</option>
                                <option>Resolved</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeCondition(id) {
            document.querySelector(`[data-condition-id="${id}"]`).remove();
        }

        function saveConditions() {
            const conditions = [];
            document.querySelectorAll('[data-condition-id]').forEach(card => {
                const condition = {};
                card.querySelectorAll('.condition-field').forEach(field => {
                    condition[field.dataset.field] = field.value;
                });
                conditions.push(condition);
            });
            state.secureData.ehr.conditions = conditions;
        }

        function loadConditions() {
            const container = document.getElementById('conditions-container');
            if (!container) return;
            
            container.innerHTML = '';
            const conditions = state.secureData.ehr.conditions || [];
            
            conditions.forEach(condition => {
                addCondition();
                const card = container.lastElementChild;
                Object.keys(condition).forEach(field => {
                    const input = card.querySelector(`[data-field="${field}"]`);
                    if (input) input.value = condition[field];
                });
            });
        }

        function addCaseNote() {
            const container = document.getElementById('case-notes-container');
            const id = 'note_' + Date.now();
            const today = new Date().toISOString().split('T')[0];
            
            const html = `
                <div class="case-note" data-note-id="${id}">
                    <div class="note-header">
                        <input type="date" class="note-field" data-id="${id}" data-field="date" value="${today}">
                        <button class="delete-btn" onclick="removeNote('${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea class="note-field" data-id="${id}" data-field="content" rows="4"></textarea>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeNote(id) {
            document.querySelector(`[data-note-id="${id}"]`).remove();
        }

        function saveCaseNotes() {
            const notes = [];
            document.querySelectorAll('[data-note-id]').forEach(card => {
                const note = {};
                card.querySelectorAll('.note-field').forEach(field => {
                    note[field.dataset.field] = field.value;
                });
                notes.push(note);
            });
            state.secureData.ehr.caseNotes = notes;
        }

        function loadCaseNotes() {
            const container = document.getElementById('case-notes-container');
            if (!container) return;
            
            container.innerHTML = '';
            const notes = state.secureData.ehr.caseNotes || [];
            
            notes.forEach(note => {
                addCaseNote();
                const card = container.lastElementChild;
                Object.keys(note).forEach(field => {
                    const input = card.querySelector(`[data-field="${field}"]`);
                    if (input) input.value = note[field];
                });
            });
        }

        // Recovery Codes

        // Utility Functions
        function showStatus(message, type = 'info') {
            const statusBar = document.getElementById('status-bar');
            const statusText = document.getElementById('status-text');
            const statusIcon = document.getElementById('status-icon');

            const icons = {
                success: '✓',
                error: '✗',
                warning: '⚠',
                info: 'ℹ',
                sync: '↻'
            };

            statusIcon.textContent = icons[type] || icons.info;
            statusText.textContent = message;

            statusBar.className = 'status-bar active ' + type;

            clearTimeout(window.statusTimeout);
            if (type !== 'sync') {
                window.statusTimeout = setTimeout(() => {
                    statusBar.classList.remove('active');
                }, 3000);
            }
        }

        function updateSecurityUI() {
            if (state.passwordUnlocked) {
                document.getElementById('lockIcon').textContent = '🔒';
                document.getElementById('lockText').textContent = 'Fully Secured';
                document.getElementById('securityBadge').className = 'security-badge badge-password';
                document.getElementById('ehrTab').classList.remove('hidden', 'locked');
                document.getElementById('healthTab').classList.remove('locked');
                document.getElementById('securityTab').classList.remove('locked');
                document.getElementById('passwordBtn').style.display = 'inline-flex';
            } else if (state.pinUnlocked) {
                document.getElementById('lockIcon').textContent = '🔐';
                document.getElementById('lockText').textContent = 'PIN Protected';
                document.getElementById('securityBadge').className = 'security-badge badge-pin';
                document.getElementById('healthTab').classList.remove('locked');
                document.getElementById('securityTab').classList.remove('locked');
                document.getElementById('ehrTab').classList.add('locked', 'hidden');
                document.getElementById('passwordBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('lockIcon').textContent = '🔓';
                document.getElementById('lockText').textContent = 'Public Access';
                document.getElementById('securityBadge').className = 'security-badge badge-public';
                document.getElementById('healthTab').classList.add('locked');
                document.getElementById('securityTab').classList.add('locked');
                document.getElementById('ehrTab').classList.add('locked', 'hidden');
                document.getElementById('passwordBtn').style.display = 'none';
            }
        }

        async function exportData() {
            const exportData = {
                version: APP_VERSION,
                guid: state.currentGUID,
                timestamp: new Date().toISOString(),
                publicData: state.publicData,
                protectedData: state.pinKey ? state.protectedData : null,
                secureData: state.passwordKey ? state.secureData : null
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ikey-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function exportEHR() {
            // Generate HTML report
            const report = generateEHRReport();
            const blob = new Blob([report], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ehr-report-${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateEHRReport() {
            const ehr = state.secureData.ehr || {};
            const emergency = state.publicData.emergency || {};
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Electronic Health Record</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #4F46E5; border-bottom: 2px solid #4F46E5; padding-bottom: 10px; }
                        h2 { color: #666; margin-top: 30px; }
                        .section { margin-bottom: 30px; }
                        .field { margin: 10px 0; }
                        .label { font-weight: bold; display: inline-block; width: 150px; }
                        .value { display: inline-block; }
                        .provider, .medication, .condition { 
                            background: #f5f5f5; 
                            padding: 10px; 
                            margin: 10px 0; 
                            border-radius: 5px; 
                        }
                    </style>
                </head>
                <body>
                    <h1>Electronic Health Record</h1>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                    
                    <div class="section">
                        <h2>Emergency Information</h2>
                        <div class="field"><span class="label">Name:</span> <span class="value">${emergency.name || 'Not set'}</span></div>
                        <div class="field"><span class="label">Blood Type:</span> <span class="value">${emergency.bloodType || 'Unknown'}</span></div>
                        <div class="field"><span class="label">Allergies:</span> <span class="value">${emergency.allergies || 'None'}</span></div>
                        <div class="field"><span class="label">Medications:</span> <span class="value">${emergency.medications || 'None'}</span></div>
                        <div class="field"><span class="label">Conditions:</span> <span class="value">${emergency.conditions || 'None'}</span></div>
                    </div>
                    
                    ${ehr.providers && ehr.providers.length ? `
                        <div class="section">
                            <h2>Healthcare Providers</h2>
                            ${ehr.providers.map(p => `
                                <div class="provider">
                                    <strong>${p.name || 'Unnamed'}</strong> - ${p.specialty || 'General'}<br>
                                    Phone: ${p.phone || 'Not provided'}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${ehr.medications && ehr.medications.length ? `
                        <div class="section">
                            <h2>Current Medications</h2>
                            ${ehr.medications.map(m => `
                                <div class="medication">
                                    <strong>${m.name || 'Unnamed'}</strong><br>
                                    Dosage: ${m.dosage || 'Not specified'}<br>
                                    Frequency: ${m.frequency || 'Not specified'}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${ehr.conditions && ehr.conditions.length ? `
                        <div class="section">
                            <h2>Medical Conditions</h2>
                            ${ehr.conditions.map(c => `
                                <div class="condition">
                                    <strong>${c.name || 'Unnamed'}</strong><br>
                                    Status: ${c.status || 'Active'}<br>
                                    Since: ${c.date || 'Unknown'}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </body>
                </html>
            `;
        }

        // Auto-save on input
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('protected-data') ||
                e.target.classList.contains('ehr-data') ||
                e.target.classList.contains('provider-field') ||
                e.target.classList.contains('med-field') ||
                e.target.classList.contains('condition-field') ||
                e.target.classList.contains('note-field')) {
                triggerAutoSave();
            }
        });

        // Clipboard cleanup after copy operations
        document.addEventListener('copy', () => {
            setTimeout(() => navigator.clipboard.writeText('').catch(() => {}), 100);
        });

        // Periodic memory cleanup
        function memoryCleanup() {
            if (!state.pinUnlocked) state.pinKey = null;
            if (!state.passwordUnlocked) state.passwordKey = null;
        }
        setInterval(memoryCleanup, 5 * 60 * 1000);

        // Initialize on load with session warning and input hardening
        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('ikey_session_active')) {
                alert('Another tab might be open - warn user');
            }
            sessionStorage.setItem('ikey_session_active', 'true');
            document.querySelectorAll('input').forEach(input => {
                input.setAttribute('autocomplete', 'off');
                input.setAttribute('autocorrect', 'off');
                input.setAttribute('autocapitalize', 'off');
                input.setAttribute('spellcheck', 'false');
            });
            ThemeManager.init();
            init();
        });

        window.addEventListener('hashchange', function() {
            location.reload();
        });

        window.addEventListener('beforeunload', function() {
            state.pinKey = null;
            state.passwordKey = null;
            state.currentDoubleHash = null;
            pinEntry = '';
            localStorage.removeItem(`ikey_pin_temp_${state.currentGUID}`);
            sessionStorage.removeItem('ikey_session_active');
        });
    </script>
    <!-- Status Bar -->
    <div id="status-bar" class="status-bar">
        <div class="status-content">
            <span id="status-icon">✓</span>
            <span id="status-text">Ready</span>
        </div>
    </div>
</body>
</html>
